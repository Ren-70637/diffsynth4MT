# 灵活GPU实验系统使用指南

## 🎯 系统概述

本系统解决了原有实验框架的三个核心问题：
1. **硬编码路径** - 现在所有路径都通过配置文件管理，支持环境迁移
2. **GPU硬编码** - 支持动态GPU选择和自动检测，不再限制4块GPU
3. **增量实验** - 支持随时添加新数据，无需重新运行已完成的实验

## 📂 文件结构

```
ICLR批量实验脚本/
├── config.json                      # 增强的配置文件
├── FastVMT_flexible.py              # 灵活的实验执行脚本
├── start_flexible_experiment.sh     # 灵活启动脚本
├── monitor_flexible_experiment.sh   # 灵活监控脚本
├── incremental_manager.py           # 增量实验管理器
├── 灵活实验系统使用指南.md         # 本文档
└── [原有文件保持不变]
```

## ⚙️ 配置文件说明

### 新增配置项

```json
{
  "paths": {
    "base_path": "./Final_Dataset",           // 相对路径支持
    "output_dir": "./results_final",
    "log_dir": "./logs",
    "temp_dir": "./temp",                     // 新增临时目录
    "backup_dir": "./backup"                  // 新增备份目录
  },
  "experiment": {
    "gpu_config": {
      "auto_detect": true,                    // 自动检测GPU
      "available_gpus": [],                   // 手动指定可用GPU
      "manual_assignment": {},                // 手动分配GPU到类别
      "min_memory_gb": 16,                    // 最小显存要求
      "exclude_gpus": []                      // 排除的GPU列表
    },
    "modes": {
      "batch": {"enabled": true},             // 批量模式
      "incremental": {"enabled": true},       // 增量模式
      "single_gpu": {"enabled": true}         // 单GPU模式
    }
  }
}
```

## 🚀 基本使用方法

### 1. 批量实验（默认模式）

```bash
# 使用默认配置自动选择GPU
./start_flexible_experiment.sh

# 指定使用特定GPU
./start_flexible_experiment.sh --gpus "0 1"

# 只处理特定类别
./start_flexible_experiment.sh --categories "camera_motion single_object"

# 预览将要执行的命令（不实际运行）
./start_flexible_experiment.sh --dry-run
```

### 2. 增量实验

#### 方法一：使用增量管理器（推荐）

```bash
# 步骤1：准备增量实验
python incremental_manager.py prepare \
  --category single_object \
  --new-videos-dir /path/to/new/videos \
  --new-prompts-file /path/to/new/prompts.json \
  --backup

# 步骤2：启动增量实验
./start_flexible_experiment.sh --config config_incremental_*.json --mode incremental
```

#### 方法二：直接启动增量模式

```bash
./start_flexible_experiment.sh \
  --mode incremental \
  --new-data-dir /path/to/new/videos \
  --new-prompts /path/to/new/prompts.json
```

### 3. 单GPU实验

```bash
# 指定单个GPU
./start_flexible_experiment.sh --gpus "0" --categories "camera_motion"
```

## 📊 监控和管理

### 实时监控

```bash
# 自动检测实验类型并显示相关信息
./monitor_flexible_experiment.sh --auto

# 实时监控（5秒刷新）
./monitor_flexible_experiment.sh --monitor 5

# 查看GPU状态
./monitor_flexible_experiment.sh --overview

# 查看实验进度
./monitor_flexible_experiment.sh --progress config_incremental_*.json
```

### 日志查看

```bash
# 查看最新日志
./monitor_flexible_experiment.sh --logs 20

# 生成监控报告
./monitor_flexible_experiment.sh --report
```

### 会话管理

```bash
# 查看所有tmux会话
tmux list-sessions

# 连接到实验会话
tmux attach-session -t flexible_experiment_*

# 在会话内切换窗口
Ctrl+B 然后按 1, 2, 3...

# 退出会话（保持实验运行）
Ctrl+B 然后按 D

# 停止实验
tmux kill-session -t flexible_experiment_*
```

## 🔄 增量实验详细流程

### 场景：添加新的视频数据

1. **准备新数据**
   ```bash
   # 新视频目录结构
   /path/to/new/videos/
   ├── new_video1.mp4
   ├── new_video2.mp4
   └── ...
   
   # 新prompts文件
   /path/to/new/prompts.json
   ```

2. **合并数据到实验环境**
   ```bash
   python incremental_manager.py prepare \
     --category single_object \
     --new-videos-dir /path/to/new/videos \
     --new-prompts-file /path/to/new/prompts.json \
     --backup
   ```

3. **启动增量实验**
   ```bash
   # 系统会自动跳过已完成的实验
   ./start_flexible_experiment.sh --config config_incremental_*.json --mode incremental
   ```

4. **监控进度**
   ```bash
   ./monitor_flexible_experiment.sh --auto
   ```

### 增量管理器功能

```bash
# 查看增量实验状态
python incremental_manager.py status config_incremental_*.json

# 单独合并prompts文件
python incremental_manager.py merge \
  --base Final_Dataset/prompt.json \
  --new /path/to/new/prompts.json \
  --output merged_prompts.json
```

## 🔧 高级配置

### GPU选择策略

1. **自动检测模式**（推荐）
   ```json
   {
     "gpu_config": {
       "auto_detect": true,
       "min_memory_gb": 20,
       "exclude_gpus": [3]
     }
   }
   ```

2. **手动指定模式**
   ```json
   {
     "gpu_config": {
       "auto_detect": false,
       "available_gpus": [0, 1, 2]
     }
   }
   ```

3. **类别GPU映射**
   ```json
   {
     "gpu_config": {
       "manual_assignment": {
         "camera_motion": [0, 1],
         "single_object": [2, 3]
       }
     }
   }
   ```

### 路径配置最佳实践

1. **相对路径**（推荐，便于迁移）
   ```json
   {
     "paths": {
       "base_path": "./Final_Dataset",
       "output_dir": "./results_final"
     }
   }
   ```

2. **绝对路径**（固定环境）
   ```json
   {
     "paths": {
       "base_path": "/data/experiments/Final_Dataset",
       "output_dir": "/data/experiments/results"
     }
   }
   ```

3. **混合路径**
   ```json
   {
     "paths": {
       "base_path": "./Final_Dataset",           // 相对路径
       "model_path": "/shared/models/wan2.1"     // 绝对路径
     }
   }
   ```

## 🐛 故障排除

### 常见问题

1. **GPU检测失败**
   ```bash
   # 检查nvidia-smi
   nvidia-smi
   
   # 检查GPU状态
   ./monitor_flexible_experiment.sh --overview
   ```

2. **路径找不到**
   ```bash
   # 检查配置文件
   python -c "import json; print(json.load(open('config.json', 'r'))['paths'])"
   
   # 检查工作目录
   pwd
   ```

3. **增量实验不生效**
   ```bash
   # 查看增量配置
   python incremental_manager.py status config_incremental_*.json
   
   # 检查已存在的结果
   find results_final -name "*.mp4" | wc -l
   ```

### 调试模式

```bash
# 干运行模式
./start_flexible_experiment.sh --dry-run

# 详细日志
./monitor_flexible_experiment.sh --logs 50

# 进程状态
./monitor_flexible_experiment.sh --processes
```

## 📈 性能优化建议

### GPU配置优化

| GPU显存 | 推荐配置 | 预期性能 |
|---------|----------|----------|
| 16GB | `processes_per_gpu: 1` | 基础性能 |
| 24GB | `processes_per_gpu: 2` | 2倍提升 |
| 48GB | `processes_per_gpu: 3` | 3倍提升 |
| 80GB | `processes_per_gpu: 4` | 4倍提升 |

### 显存分配策略

```json
{
  "parallel_config": {
    "memory_fraction_per_process": 0.45,    // 保守设置
    "memory_fraction_per_process": 0.7      // 激进设置（单进程）
  }
}
```

### 文件分割策略

- `balanced`: 平均分配（默认推荐）
- `random`: 随机分配（负载不均时）
- `sequential`: 顺序分配（调试时）

## 🔄 环境迁移指南

### 迁移到新主机

1. **复制实验目录**
   ```bash
   rsync -av /old/host/ICLR批量实验脚本/ /new/host/ICLR批量实验脚本/
   ```

2. **更新配置文件**
   ```json
   {
     "environment": {
       "conda_path": "/new/path/to/conda.sh",
       "conda_env": "diffsynth",
       "work_dir": "/new/host/ICLR批量实验脚本"
     }
   }
   ```

3. **测试环境**
   ```bash
   ./start_flexible_experiment.sh --dry-run
   ```

### 不同GPU配置适配

系统会自动检测GPU数量和显存，无需手动配置。

## 🆚 与原方案对比

| 特性 | 原方案 | 新灵活方案 |
|------|--------|------------|
| 路径管理 | 硬编码 | 配置文件驱动 |
| GPU选择 | 固定4块 | 动态检测，灵活选择 |
| 增量实验 | 不支持 | 完整支持 |
| 环境迁移 | 困难 | 简单 |
| 监控粒度 | 基础 | 精细化 |
| 并行策略 | 固定 | 可配置 |

## 📝 使用示例

### 示例1：标准批量实验

```bash
# 启动标准实验
./start_flexible_experiment.sh

# 监控进度
./monitor_flexible_experiment.sh --auto
```

### 示例2：指定GPU实验

```bash
# 只使用GPU 0和1
./start_flexible_experiment.sh --gpus "0 1"

# 实时监控
./monitor_flexible_experiment.sh --monitor 3
```

### 示例3：增量添加新数据

```bash
# 准备增量数据
python incremental_manager.py prepare \
  --category camera_motion \
  --new-videos-dir ./new_camera_videos \
  --new-prompts-file ./new_prompts.json

# 启动增量实验
./start_flexible_experiment.sh --config config_incremental_*.json --mode incremental

# 查看增量状态
python incremental_manager.py status config_incremental_*.json
```

---

## 🎉 总结

新的灵活实验系统提供了：

✅ **完全可配置的路径管理** - 支持环境迁移  
✅ **智能GPU选择** - 自动检测，灵活分配  
✅ **增量实验支持** - 随时添加新数据  
✅ **统一的监控界面** - 实时状态跟踪  
✅ **向后兼容** - 原有功能保持不变  

通过本系统，您可以轻松地在不同主机间迁移实验环境，灵活地使用不同数量的GPU，并且可以随时向现有实验中添加新的数据，大大提高了实验的灵活性和效率！
