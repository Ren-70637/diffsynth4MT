# çµæ´»GPUå®éªŒç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿè§£å†³äº†åŸæœ‰å®éªŒæ¡†æ¶çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **ç¡¬ç¼–ç è·¯å¾„** - ç°åœ¨æ‰€æœ‰è·¯å¾„éƒ½é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œæ”¯æŒç¯å¢ƒè¿ç§»
2. **GPUç¡¬ç¼–ç ** - æ”¯æŒåŠ¨æ€GPUé€‰æ‹©å’Œè‡ªåŠ¨æ£€æµ‹ï¼Œä¸å†é™åˆ¶4å—GPU
3. **å¢é‡å®éªŒ** - æ”¯æŒéšæ—¶æ·»åŠ æ–°æ•°æ®ï¼Œæ— éœ€é‡æ–°è¿è¡Œå·²å®Œæˆçš„å®éªŒ

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
ICLRæ‰¹é‡å®éªŒè„šæœ¬/
â”œâ”€â”€ config.json                      # å¢å¼ºçš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ FastVMT_flexible.py              # çµæ´»çš„å®éªŒæ‰§è¡Œè„šæœ¬
â”œâ”€â”€ start_flexible_experiment.sh     # çµæ´»å¯åŠ¨è„šæœ¬
â”œâ”€â”€ monitor_flexible_experiment.sh   # çµæ´»ç›‘æ§è„šæœ¬
â”œâ”€â”€ incremental_manager.py           # å¢é‡å®éªŒç®¡ç†å™¨
â”œâ”€â”€ çµæ´»å®éªŒç³»ç»Ÿä½¿ç”¨æŒ‡å—.md         # æœ¬æ–‡æ¡£
â””â”€â”€ [åŸæœ‰æ–‡ä»¶ä¿æŒä¸å˜]
```

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

### æ–°å¢é…ç½®é¡¹

```json
{
  "paths": {
    "base_path": "./Final_Dataset",           // ç›¸å¯¹è·¯å¾„æ”¯æŒ
    "output_dir": "./results_final",
    "log_dir": "./logs",
    "temp_dir": "./temp",                     // æ–°å¢ä¸´æ—¶ç›®å½•
    "backup_dir": "./backup"                  // æ–°å¢å¤‡ä»½ç›®å½•
  },
  "experiment": {
    "gpu_config": {
      "auto_detect": true,                    // è‡ªåŠ¨æ£€æµ‹GPU
      "available_gpus": [],                   // æ‰‹åŠ¨æŒ‡å®šå¯ç”¨GPU
      "manual_assignment": {},                // æ‰‹åŠ¨åˆ†é…GPUåˆ°ç±»åˆ«
      "min_memory_gb": 16,                    // æœ€å°æ˜¾å­˜è¦æ±‚
      "exclude_gpus": []                      // æ’é™¤çš„GPUåˆ—è¡¨
    },
    "modes": {
      "batch": {"enabled": true},             // æ‰¹é‡æ¨¡å¼
      "incremental": {"enabled": true},       // å¢é‡æ¨¡å¼
      "single_gpu": {"enabled": true}         // å•GPUæ¨¡å¼
    }
  }
}
```

## ğŸš€ åŸºæœ¬ä½¿ç”¨æ–¹æ³•

### 1. æ‰¹é‡å®éªŒï¼ˆé»˜è®¤æ¨¡å¼ï¼‰

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®è‡ªåŠ¨é€‰æ‹©GPU
./start_flexible_experiment.sh

# æŒ‡å®šä½¿ç”¨ç‰¹å®šGPU
./start_flexible_experiment.sh --gpus "0 1"

# åªå¤„ç†ç‰¹å®šç±»åˆ«
./start_flexible_experiment.sh --categories "camera_motion single_object"

# é¢„è§ˆå°†è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆä¸å®é™…è¿è¡Œï¼‰
./start_flexible_experiment.sh --dry-run
```

### 2. å¢é‡å®éªŒ

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å¢é‡ç®¡ç†å™¨ï¼ˆæ¨èï¼‰

```bash
# æ­¥éª¤1ï¼šå‡†å¤‡å¢é‡å®éªŒ
python incremental_manager.py prepare \
  --category single_object \
  --new-videos-dir /path/to/new/videos \
  --new-prompts-file /path/to/new/prompts.json \
  --backup

# æ­¥éª¤2ï¼šå¯åŠ¨å¢é‡å®éªŒ
./start_flexible_experiment.sh --config config_incremental_*.json --mode incremental
```

#### æ–¹æ³•äºŒï¼šç›´æ¥å¯åŠ¨å¢é‡æ¨¡å¼

```bash
./start_flexible_experiment.sh \
  --mode incremental \
  --new-data-dir /path/to/new/videos \
  --new-prompts /path/to/new/prompts.json
```

### 3. å•GPUå®éªŒ

```bash
# æŒ‡å®šå•ä¸ªGPU
./start_flexible_experiment.sh --gpus "0" --categories "camera_motion"
```

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### å®æ—¶ç›‘æ§

```bash
# è‡ªåŠ¨æ£€æµ‹å®éªŒç±»å‹å¹¶æ˜¾ç¤ºç›¸å…³ä¿¡æ¯
./monitor_flexible_experiment.sh --auto

# å®æ—¶ç›‘æ§ï¼ˆ5ç§’åˆ·æ–°ï¼‰
./monitor_flexible_experiment.sh --monitor 5

# æŸ¥çœ‹GPUçŠ¶æ€
./monitor_flexible_experiment.sh --overview

# æŸ¥çœ‹å®éªŒè¿›åº¦
./monitor_flexible_experiment.sh --progress config_incremental_*.json
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
./monitor_flexible_experiment.sh --logs 20

# ç”Ÿæˆç›‘æ§æŠ¥å‘Š
./monitor_flexible_experiment.sh --report
```

### ä¼šè¯ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰tmuxä¼šè¯
tmux list-sessions

# è¿æ¥åˆ°å®éªŒä¼šè¯
tmux attach-session -t flexible_experiment_*

# åœ¨ä¼šè¯å†…åˆ‡æ¢çª—å£
Ctrl+B ç„¶åæŒ‰ 1, 2, 3...

# é€€å‡ºä¼šè¯ï¼ˆä¿æŒå®éªŒè¿è¡Œï¼‰
Ctrl+B ç„¶åæŒ‰ D

# åœæ­¢å®éªŒ
tmux kill-session -t flexible_experiment_*
```

## ğŸ”„ å¢é‡å®éªŒè¯¦ç»†æµç¨‹

### åœºæ™¯ï¼šæ·»åŠ æ–°çš„è§†é¢‘æ•°æ®

1. **å‡†å¤‡æ–°æ•°æ®**
   ```bash
   # æ–°è§†é¢‘ç›®å½•ç»“æ„
   /path/to/new/videos/
   â”œâ”€â”€ new_video1.mp4
   â”œâ”€â”€ new_video2.mp4
   â””â”€â”€ ...
   
   # æ–°promptsæ–‡ä»¶
   /path/to/new/prompts.json
   ```

2. **åˆå¹¶æ•°æ®åˆ°å®éªŒç¯å¢ƒ**
   ```bash
   python incremental_manager.py prepare \
     --category single_object \
     --new-videos-dir /path/to/new/videos \
     --new-prompts-file /path/to/new/prompts.json \
     --backup
   ```

3. **å¯åŠ¨å¢é‡å®éªŒ**
   ```bash
   # ç³»ç»Ÿä¼šè‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„å®éªŒ
   ./start_flexible_experiment.sh --config config_incremental_*.json --mode incremental
   ```

4. **ç›‘æ§è¿›åº¦**
   ```bash
   ./monitor_flexible_experiment.sh --auto
   ```

### å¢é‡ç®¡ç†å™¨åŠŸèƒ½

```bash
# æŸ¥çœ‹å¢é‡å®éªŒçŠ¶æ€
python incremental_manager.py status config_incremental_*.json

# å•ç‹¬åˆå¹¶promptsæ–‡ä»¶
python incremental_manager.py merge \
  --base Final_Dataset/prompt.json \
  --new /path/to/new/prompts.json \
  --output merged_prompts.json
```

## ğŸ”§ é«˜çº§é…ç½®

### GPUé€‰æ‹©ç­–ç•¥

1. **è‡ªåŠ¨æ£€æµ‹æ¨¡å¼**ï¼ˆæ¨èï¼‰
   ```json
   {
     "gpu_config": {
       "auto_detect": true,
       "min_memory_gb": 20,
       "exclude_gpus": [3]
     }
   }
   ```

2. **æ‰‹åŠ¨æŒ‡å®šæ¨¡å¼**
   ```json
   {
     "gpu_config": {
       "auto_detect": false,
       "available_gpus": [0, 1, 2]
     }
   }
   ```

3. **ç±»åˆ«GPUæ˜ å°„**
   ```json
   {
     "gpu_config": {
       "manual_assignment": {
         "camera_motion": [0, 1],
         "single_object": [2, 3]
       }
     }
   }
   ```

### è·¯å¾„é…ç½®æœ€ä½³å®è·µ

1. **ç›¸å¯¹è·¯å¾„**ï¼ˆæ¨èï¼Œä¾¿äºè¿ç§»ï¼‰
   ```json
   {
     "paths": {
       "base_path": "./Final_Dataset",
       "output_dir": "./results_final"
     }
   }
   ```

2. **ç»å¯¹è·¯å¾„**ï¼ˆå›ºå®šç¯å¢ƒï¼‰
   ```json
   {
     "paths": {
       "base_path": "/data/experiments/Final_Dataset",
       "output_dir": "/data/experiments/results"
     }
   }
   ```

3. **æ··åˆè·¯å¾„**
   ```json
   {
     "paths": {
       "base_path": "./Final_Dataset",           // ç›¸å¯¹è·¯å¾„
       "model_path": "/shared/models/wan2.1"     // ç»å¯¹è·¯å¾„
     }
   }
   ```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **GPUæ£€æµ‹å¤±è´¥**
   ```bash
   # æ£€æŸ¥nvidia-smi
   nvidia-smi
   
   # æ£€æŸ¥GPUçŠ¶æ€
   ./monitor_flexible_experiment.sh --overview
   ```

2. **è·¯å¾„æ‰¾ä¸åˆ°**
   ```bash
   # æ£€æŸ¥é…ç½®æ–‡ä»¶
   python -c "import json; print(json.load(open('config.json', 'r'))['paths'])"
   
   # æ£€æŸ¥å·¥ä½œç›®å½•
   pwd
   ```

3. **å¢é‡å®éªŒä¸ç”Ÿæ•ˆ**
   ```bash
   # æŸ¥çœ‹å¢é‡é…ç½®
   python incremental_manager.py status config_incremental_*.json
   
   # æ£€æŸ¥å·²å­˜åœ¨çš„ç»“æœ
   find results_final -name "*.mp4" | wc -l
   ```

### è°ƒè¯•æ¨¡å¼

```bash
# å¹²è¿è¡Œæ¨¡å¼
./start_flexible_experiment.sh --dry-run

# è¯¦ç»†æ—¥å¿—
./monitor_flexible_experiment.sh --logs 50

# è¿›ç¨‹çŠ¶æ€
./monitor_flexible_experiment.sh --processes
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### GPUé…ç½®ä¼˜åŒ–

| GPUæ˜¾å­˜ | æ¨èé…ç½® | é¢„æœŸæ€§èƒ½ |
|---------|----------|----------|
| 16GB | `processes_per_gpu: 1` | åŸºç¡€æ€§èƒ½ |
| 24GB | `processes_per_gpu: 2` | 2å€æå‡ |
| 48GB | `processes_per_gpu: 3` | 3å€æå‡ |
| 80GB | `processes_per_gpu: 4` | 4å€æå‡ |

### æ˜¾å­˜åˆ†é…ç­–ç•¥

```json
{
  "parallel_config": {
    "memory_fraction_per_process": 0.45,    // ä¿å®ˆè®¾ç½®
    "memory_fraction_per_process": 0.7      // æ¿€è¿›è®¾ç½®ï¼ˆå•è¿›ç¨‹ï¼‰
  }
}
```

### æ–‡ä»¶åˆ†å‰²ç­–ç•¥

- `balanced`: å¹³å‡åˆ†é…ï¼ˆé»˜è®¤æ¨èï¼‰
- `random`: éšæœºåˆ†é…ï¼ˆè´Ÿè½½ä¸å‡æ—¶ï¼‰
- `sequential`: é¡ºåºåˆ†é…ï¼ˆè°ƒè¯•æ—¶ï¼‰

## ğŸ”„ ç¯å¢ƒè¿ç§»æŒ‡å—

### è¿ç§»åˆ°æ–°ä¸»æœº

1. **å¤åˆ¶å®éªŒç›®å½•**
   ```bash
   rsync -av /old/host/ICLRæ‰¹é‡å®éªŒè„šæœ¬/ /new/host/ICLRæ‰¹é‡å®éªŒè„šæœ¬/
   ```

2. **æ›´æ–°é…ç½®æ–‡ä»¶**
   ```json
   {
     "environment": {
       "conda_path": "/new/path/to/conda.sh",
       "conda_env": "diffsynth",
       "work_dir": "/new/host/ICLRæ‰¹é‡å®éªŒè„šæœ¬"
     }
   }
   ```

3. **æµ‹è¯•ç¯å¢ƒ**
   ```bash
   ./start_flexible_experiment.sh --dry-run
   ```

### ä¸åŒGPUé…ç½®é€‚é…

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹GPUæ•°é‡å’Œæ˜¾å­˜ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

## ğŸ†š ä¸åŸæ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | åŸæ–¹æ¡ˆ | æ–°çµæ´»æ–¹æ¡ˆ |
|------|--------|------------|
| è·¯å¾„ç®¡ç† | ç¡¬ç¼–ç  | é…ç½®æ–‡ä»¶é©±åŠ¨ |
| GPUé€‰æ‹© | å›ºå®š4å— | åŠ¨æ€æ£€æµ‹ï¼Œçµæ´»é€‰æ‹© |
| å¢é‡å®éªŒ | ä¸æ”¯æŒ | å®Œæ•´æ”¯æŒ |
| ç¯å¢ƒè¿ç§» | å›°éš¾ | ç®€å• |
| ç›‘æ§ç²’åº¦ | åŸºç¡€ | ç²¾ç»†åŒ– |
| å¹¶è¡Œç­–ç•¥ | å›ºå®š | å¯é…ç½® |

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ ‡å‡†æ‰¹é‡å®éªŒ

```bash
# å¯åŠ¨æ ‡å‡†å®éªŒ
./start_flexible_experiment.sh

# ç›‘æ§è¿›åº¦
./monitor_flexible_experiment.sh --auto
```

### ç¤ºä¾‹2ï¼šæŒ‡å®šGPUå®éªŒ

```bash
# åªä½¿ç”¨GPU 0å’Œ1
./start_flexible_experiment.sh --gpus "0 1"

# å®æ—¶ç›‘æ§
./monitor_flexible_experiment.sh --monitor 3
```

### ç¤ºä¾‹3ï¼šå¢é‡æ·»åŠ æ–°æ•°æ®

```bash
# å‡†å¤‡å¢é‡æ•°æ®
python incremental_manager.py prepare \
  --category camera_motion \
  --new-videos-dir ./new_camera_videos \
  --new-prompts-file ./new_prompts.json

# å¯åŠ¨å¢é‡å®éªŒ
./start_flexible_experiment.sh --config config_incremental_*.json --mode incremental

# æŸ¥çœ‹å¢é‡çŠ¶æ€
python incremental_manager.py status config_incremental_*.json
```

---

## ğŸ‰ æ€»ç»“

æ–°çš„çµæ´»å®éªŒç³»ç»Ÿæä¾›äº†ï¼š

âœ… **å®Œå…¨å¯é…ç½®çš„è·¯å¾„ç®¡ç†** - æ”¯æŒç¯å¢ƒè¿ç§»  
âœ… **æ™ºèƒ½GPUé€‰æ‹©** - è‡ªåŠ¨æ£€æµ‹ï¼Œçµæ´»åˆ†é…  
âœ… **å¢é‡å®éªŒæ”¯æŒ** - éšæ—¶æ·»åŠ æ–°æ•°æ®  
âœ… **ç»Ÿä¸€çš„ç›‘æ§ç•Œé¢** - å®æ—¶çŠ¶æ€è·Ÿè¸ª  
âœ… **å‘åå…¼å®¹** - åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜  

é€šè¿‡æœ¬ç³»ç»Ÿï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°åœ¨ä¸åŒä¸»æœºé—´è¿ç§»å®éªŒç¯å¢ƒï¼Œçµæ´»åœ°ä½¿ç”¨ä¸åŒæ•°é‡çš„GPUï¼Œå¹¶ä¸”å¯ä»¥éšæ—¶å‘ç°æœ‰å®éªŒä¸­æ·»åŠ æ–°çš„æ•°æ®ï¼Œå¤§å¤§æé«˜äº†å®éªŒçš„çµæ´»æ€§å’Œæ•ˆç‡ï¼
