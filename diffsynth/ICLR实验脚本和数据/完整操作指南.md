# 🎯 灵活GPU实验系统 - 完整操作指南

## 📋 快速开始清单

### 1️⃣ **环境检查**
```bash
# 进入工作目录
cd /root/autodl-tmp/diffsynth4MT-main/diffsynth/ICLR实验脚本和数据

# 激活conda环境
conda activate diffsynth

# 检查GPU状态
nvidia-smi

# 验证配置
python load_config.py --validate
```

### 2️⃣ **清理旧会话**
```bash
# 查看所有tmux会话
tmux list-sessions

# 清理旧会话（如需要）
tmux kill-session -t flexible_experiment_1757187042
tmux kill-session -t flexible_experiment_1757187692
tmux kill-session -t test_session
```

### 3️⃣ **启动实验**
```bash
# 最简单启动（推荐新手）
./start_flexible_experiment.sh

# 预览模式（先看看会执行什么）
./start_flexible_experiment.sh --dry-run

# 指定GPU启动
./start_flexible_experiment.sh --gpus "0 1 2 3"

# 只处理特定类别
./start_flexible_experiment.sh --categories "camera_motion"
```

## 🚀 详细操作步骤

### **步骤一：启动准备**

1. **环境激活**：
   ```bash
   cd /root/autodl-tmp/diffsynth4MT-main/diffsynth/ICLR实验脚本和数据
   conda activate diffsynth
   ```

2. **系统检查**：
   ```bash
   # 检查GPU
   ./start_flexible_experiment.sh --status
   
   # 验证配置
   python load_config.py --validate
   ```

### **步骤二：实验启动**

**🎯 方案A：标准全量实验**
```bash
# 使用所有4个GPU，处理所有类别
./start_flexible_experiment.sh
```

**🎯 方案B：指定GPU实验**
```bash
# 只使用前2个GPU
./start_flexible_experiment.sh --gpus "0 1"
```

**🎯 方案C：类别专项实验**
```bash
# 只处理摄像机运动类别
./start_flexible_experiment.sh --categories "camera_motion"

# 处理多个类别
./start_flexible_experiment.sh --categories "camera_motion single_object"
```

### **步骤三：监控管理**

1. **连接到实验会话**：
   ```bash
   # 查看所有会话
   tmux list-sessions
   
   # 连接到最新会话
   tmux attach-session -t flexible_experiment_[时间戳]
   ```

2. **会话内操作**：
   - `Ctrl+B` 然后按 `1`: 切换到主实验窗口
   - `Ctrl+B` 然后按 `2`: 切换到GPU监控窗口
   - `Ctrl+B` 然后按 `D`: 退出会话但保持运行

3. **监控脚本**：
   ```bash
   # 实时监控（推荐）
   ./monitor_flexible_experiment.sh --monitor 5
   
   # 快速状态查看
   ./monitor_flexible_experiment.sh --auto
   
   # 查看实验进度
   ./monitor_flexible_experiment.sh --progress
   ```

### **步骤四：结果管理**

1. **查看输出**：
   ```bash
   # 检查输出目录
   ls -la /root/autodl-tmp/results_final/
   
   # 统计生成的视频
   find /root/autodl-tmp/results_final/ -name "*.mp4" | wc -l
   ```

2. **日志查看**：
   ```bash
   # 最新日志
   ./monitor_flexible_experiment.sh --logs 20
   
   # 特定GPU日志
   ls /root/autodl-tmp/logs/gpu_*/
   ```

## 🔧 高级配置选项

### **GPU配置调优**

编辑 `config.json`：
```json
{
  "experiment": {
    "parallel_config": {
      "processes_per_gpu": 3,        // 每GPU进程数
      "memory_fraction_per_process": 0.33,  // 显存分配比例
      "max_concurrent_videos": 3     // 最大并发视频数
    }
  }
}
```

### **路径配置**

如需更改路径，编辑 `config.json`：
```json
{
  "paths": {
    "base_path": "/root/autodl-tmp/Final_Dataset",
    "output_dir": "/root/autodl-tmp/results_final",
    "log_dir": "/root/autodl-tmp/logs"
  }
}
```

## 🐛 故障排除

### **常见问题及解决方案**

1. **脚本启动无输出**：
   ```bash
   # 使用调试模式
   bash -x ./start_flexible_experiment.sh --dry-run
   
   # 检查tmux会话
   tmux list-sessions
   tmux attach-session -t [会话名]
   ```

2. **GPU内存不足**：
   ```bash
   # 减少每GPU进程数
   # 在config.json中将processes_per_gpu改为1或2
   
   # 或者只使用部分GPU
   ./start_flexible_experiment.sh --gpus "0 1"
   ```

3. **配置文件错误**：
   ```bash
   # 验证配置
   python load_config.py --validate
   
   # 重新生成默认配置
   python load_config.py --create-default
   ```

4. **磁盘空间不足**：
   ```bash
   # 检查空间
   df -h /root/autodl-tmp/
   
   # 清理旧结果
   rm -rf /root/autodl-tmp/results_final/old_*
   ```

## 📊 性能优化建议

### **GPU配置推荐**

| GPU显存 | processes_per_gpu | memory_fraction_per_process | 预期性能 |
|---------|-------------------|----------------------------|----------|
| 80GB    | 4                 | 0.25                       | 最高     |
| 80GB    | 3                 | 0.33                       | 推荐     |
| 80GB    | 2                 | 0.45                       | 稳定     |
| 80GB    | 1                 | 0.8                        | 保守     |

### **并发策略**

- **高性能模式**：`processes_per_gpu: 4, memory_fraction: 0.25`
- **平衡模式**：`processes_per_gpu: 3, memory_fraction: 0.33` ⭐推荐
- **稳定模式**：`processes_per_gpu: 2, memory_fraction: 0.45`

## 📈 监控指标说明

### **关键指标**

1. **GPU利用率**：目标 > 80%
2. **显存使用率**：目标 70-90%
3. **进程状态**：应该看到多个Python进程
4. **输出文件**：视频文件持续增加

### **正常运行标志**

- ✅ tmux会话活跃
- ✅ Python进程运行中
- ✅ GPU显存被占用
- ✅ 输出目录中视频文件增加
- ✅ 日志文件持续更新

## 🎯 最佳实践

1. **实验前**：
   - 验证配置文件
   - 检查磁盘空间
   - 确认数据完整性

2. **实验中**：
   - 定期监控GPU状态
   - 关注日志输出
   - 检查输出文件增长

3. **实验后**：
   - 备份重要结果
   - 清理临时文件
   - 终止tmux会话

## 📞 获取帮助

```bash
# 查看启动脚本帮助
./start_flexible_experiment.sh --help

# 查看监控脚本帮助
./monitor_flexible_experiment.sh --help

# 查看完整指南
cat 灵活实验系统使用指南.md
```

---

**✨ 记住：这个系统的设计目标是简化GPU实验流程，如有任何问题，先尝试 `--dry-run` 模式预览操作！**


