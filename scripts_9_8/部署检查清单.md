# 多GPU并行视频生成实验 - 部署检查清单

## ✅ 已创建的文件清单

### 核心脚本
- [x] `FastVMT_multi_gpu.py` - 多GPU并行视频生成主程序
- [x] `start_multi_gpu_experiment.sh` - 实验启动脚本
- [x] `stop_experiment.sh` - 实验停止脚本
- [x] `monitor_experiment.sh` - 实验监控脚本
- [x] `check_results.sh` - 结果检查脚本
- [x] `tmux_manager.sh` - tmux会话管理器

### 文档
- [x] `多GPU实验运行详细操作文档.md` - 详细操作指南
- [x] `实验启动指南.md` - 快速启动指南
- [x] `部署检查清单.md` - 本文件

## 🔧 部署前检查

### 1. 环境检查
```bash
# 检查GPU数量和状态
nvidia-smi | grep "Tesla\|GeForce\|RTX\|H20"

# 检查conda环境
conda info --envs | grep diffsynth

# 检查Python包
conda activate diffsynth
python -c "import torch; print(f'PyTorch: {torch.__version__}, CUDA: {torch.cuda.is_available()}')"
python -c "import diffsynth; print('DiffSynth available')"
```

### 2. 数据文件检查
```bash
# 检查prompts文件
ls -la /root/autodl-tmp/Final_Dataset/prompt.json

# 检查视频文件
find /root/autodl-tmp/Final_Dataset -name "*.mp4" | wc -l

# 验证每个类别的视频文件
ls -la /root/autodl-tmp/Final_Dataset/camera_motion/
ls -la /root/autodl-tmp/Final_Dataset/single_object/
ls -la /root/autodl-tmp/Final_Dataset/multiple_objects/
ls -la /root/autodl-tmp/Final_Dataset/complex_human_motion/
```

### 3. 模型文件检查
```bash
# 检查Wan2.1-T2V-14B模型文件
ls -la /root/autodl-tmp/pretrained_models/Wan-AI/Wan2.1-T2V-14B/

# 验证所有模型文件存在
file_list=(
    "diffusion_pytorch_model-00001-of-00006.safetensors"
    "diffusion_pytorch_model-00002-of-00006.safetensors"
    "diffusion_pytorch_model-00003-of-00006.safetensors"
    "diffusion_pytorch_model-00004-of-00006.safetensors"
    "diffusion_pytorch_model-00005-of-00006.safetensors"
    "diffusion_pytorch_model-00006-of-00006.safetensors"
    "models_t5_umt5-xxl-enc-bf16.pth"
    "Wan2.1_VAE.pth"
)

for file in "${file_list[@]}"; do
    if [ -f "/root/autodl-tmp/pretrained_models/Wan-AI/Wan2.1-T2V-14B/$file" ]; then
        echo "✅ $file"
    else
        echo "❌ $file 缺失"
    fi
done
```

### 4. 权限检查
```bash
# 检查脚本执行权限
ls -la /root/autodl-tmp/diffsynth4MT/*.sh
```

### 5. 磁盘空间检查
```bash
# 检查可用磁盘空间 (建议至少100GB)
df -h /root/autodl-tmp/

# 创建必要目录
mkdir -p /root/autodl-tmp/results_final
mkdir -p /root/autodl-tmp/logs/{gpu_0,gpu_1,gpu_2,gpu_3}
```

## 🚀 启动前最后检查

### 验证脚本
```bash
cd /root/autodl-tmp/diffsynth4MT

# 测试脚本语法
bash -n start_multi_gpu_experiment.sh
bash -n stop_experiment.sh
bash -n monitor_experiment.sh
bash -n check_results.sh
bash -n tmux_manager.sh

# 测试Python脚本语法
python -m py_compile FastVMT_multi_gpu.py
```

### 依赖检查
```bash
# 检查tmux
which tmux || echo "需要安装: sudo apt-get install tmux"

# 检查bc (用于计算)
which bc || echo "需要安装: sudo apt-get install bc"

# 检查ffprobe (用于视频验证)
which ffprobe || echo "需要安装: sudo apt-get install ffmpeg"
```

## 📋 实验配置总结

### GPU分配
- **GPU 0**: camera_motion (镜头运动) - 17个视频 × 5个prompt × 2个seed = 170个任务
- **GPU 1**: single_object (单个物体) - 30个视频 × 5个prompt × 2个seed = 300个任务
- **GPU 2**: multiple_objects (多个物体) - 20个视频 × 5个prompt × 2个seed = 200个任务
- **GPU 3**: complex_human_motion (复杂人体运动) - 13个视频 × 5个prompt × 2个seed = 130个任务

### 预期结果
- **总视频数**: 800个
- **总存储空间**: 约50-100GB
- **预计时间**: 4-8小时
- **Seeds**: 42, 123

### 输出结构
```
/root/autodl-tmp/results_final/
├── camera_motion/
├── single_object/
├── multiple_objects/
└── complex_human_motion/
    └── ref_xxx_832x480/
        ├── prompt1_seed42/video1.mp4
        ├── prompt1_seed123/video1.mp4
        ├── prompt2_seed42/video1.mp4
        ├── prompt2_seed123/video1.mp4
        ├── prompt3_seed42/video1.mp4
        ├── prompt3_seed123/video1.mp4
        ├── prompt4_seed42/video1.mp4
        ├── prompt4_seed123/video1.mp4
        ├── prompt5_seed42/video1.mp4
        └── prompt5_seed123/video1.mp4
```

## 🎯 启动命令

### 一键启动
```bash
cd /root/autodl-tmp/diffsynth4MT
./start_multi_gpu_experiment.sh
```

### 监控命令
```bash
# 实时监控
./monitor_experiment.sh

# 会话管理
./tmux_manager.sh

# 自动刷新监控
watch -n 30 ./monitor_experiment.sh
```

### 停止命令
```bash
./stop_experiment.sh
```

## ⚠️ 注意事项

1. **保持连接**: 使用tmux确保SSH断开时实验继续运行
2. **监控资源**: 定期检查GPU使用率和磁盘空间
3. **备份日志**: 实验过程中的日志文件很重要
4. **错误处理**: 如果某个GPU失败，可以手动重启该GPU的任务

## 🔍 故障排除

### 常见问题
1. **显存不足**: 调整num_persistent参数
2. **模型路径错误**: 检查模型文件完整性
3. **权限问题**: 确保所有脚本有执行权限
4. **依赖缺失**: 安装必要的系统包

### 紧急恢复
```bash
# 强制停止所有进程
pkill -f FastVMT_multi_gpu
tmux kill-server

# 清理GPU显存
nvidia-smi --gpu-reset

# 重新启动
./start_multi_gpu_experiment.sh
```

---

**✅ 检查完毕，可以开始实验！**

启动命令: `./start_multi_gpu_experiment.sh`