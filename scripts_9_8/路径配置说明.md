# 路径配置说明

## 🎯 概述

现在所有的硬编码路径都已经改为可配置的环境变量，可以轻松适应不同的部署环境。

## 🔧 配置方式

### 方法1：使用配置文件（推荐）

```bash
# 1. 编辑配置文件
nano config.env

# 2. 加载配置
source config.env

# 3. 运行实验
./incremental_experiment.sh --category single_object --new-prompts new.json --new-videos-dir videos/
```

### 方法2：直接设置环境变量

```bash
# 设置基础路径
export EXPERIMENT_BASE_DIR="/your/custom/path"
export EXPERIMENT_WORK_DIR="/your/custom/path/diffsynth4MT"
export EXPERIMENT_OUTPUT_DIR="/your/custom/path/results"

# 运行实验
./incremental_experiment.sh --category single_object --new-prompts new.json --new-videos-dir videos/
```

### 方法3：临时指定参数

```bash
# 使用命令行参数覆盖默认配置
./incremental_experiment.sh \
    --category single_object \
    --new-prompts /custom/path/new.json \
    --new-videos-dir /custom/path/videos \
    --output-dir /custom/path/output
```

## 📋 主要环境变量

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `EXPERIMENT_BASE_DIR` | `/root/autodl-tmp` | 实验基础目录 |
| `EXPERIMENT_WORK_DIR` | `${BASE_DIR}/diffsynth4MT` | 脚本工作目录 |
| `EXPERIMENT_OUTPUT_DIR` | `${BASE_DIR}/results_final_2` | 实验输出目录 |
| `EXPERIMENT_LOG_DIR` | `${BASE_DIR}/logs` | 日志目录 |
| `EXPERIMENT_PROMPTS_FILE` | `${BASE_DIR}/Final_Dataset/prompt.json` | 主prompts文件 |
| `MODEL_BASE_DIR` | `${BASE_DIR}/pretrained_models` | 模型文件目录 |
| `CONDA_BASE` | `/root/miniconda3` | Conda安装路径 |
| `CONDA_ENV` | `diffsynth` | Conda环境名 |

## 🚀 使用示例

### 示例1：本地开发环境

```bash
# config.env
export EXPERIMENT_BASE_DIR="/home/user/diffsynth"
export CONDA_BASE="/home/user/miniconda3"
export CONDA_ENV="my_diffsynth"

# 使用
source config.env
./incremental_experiment.sh --category single_object --new-prompts my_prompts.json --new-videos-dir my_videos/
```

### 示例2：服务器环境

```bash
# config.env  
export EXPERIMENT_BASE_DIR="/data/experiments"
export CONDA_BASE="/opt/conda"
export CONDA_ENV="production_diffsynth"
export EXPERIMENT_OUTPUT_DIR="/data/results"

# 使用
source config.env
./incremental_experiment.sh --category single_object --new-prompts /data/new_prompts.json --new-videos-dir /data/videos/
```

### 示例3：云服务器环境

```bash
# config.env
export EXPERIMENT_BASE_DIR="/workspace"
export MODEL_BASE_DIR="/shared/models"
export EXPERIMENT_OUTPUT_DIR="/shared/results"

# 使用
source config.env
./incremental_experiment.sh --category single_object --new-prompts s3://bucket/prompts.json --new-videos-dir /workspace/videos/
```

## 🔍 配置验证

### 检查当前配置

```bash
# 查看所有实验相关环境变量
env | grep EXPERIMENT

# 查看模型路径配置
env | grep MODEL

# 查看Conda配置
env | grep CONDA
```

### 验证路径有效性

```bash
# 检查关键路径是否存在
echo "工作目录: ${EXPERIMENT_WORK_DIR} - $([ -d "${EXPERIMENT_WORK_DIR}" ] && echo "✅" || echo "❌")"
echo "模型目录: ${MODEL_BASE_DIR} - $([ -d "${MODEL_BASE_DIR}" ] && echo "✅" || echo "❌")"
echo "Conda目录: ${CONDA_BASE} - $([ -d "${CONDA_BASE}" ] && echo "✅" || echo "❌")"
```

## 📁 目录结构示例

```
${EXPERIMENT_BASE_DIR}/                 # 实验基础目录
├── diffsynth4MT/                       # 脚本工作目录
│   ├── incremental_experiment.sh
│   ├── FastVMT_incremental.py
│   └── config.env
├── Final_Dataset/                      # 数据集目录
│   ├── prompt.json
│   ├── single_object/
│   └── camera_motion/
├── pretrained_models/                  # 模型目录
│   └── Wan-AI/Wan2.1-T2V-14B/
├── results_final_2/                    # 输出目录
│   ├── single_object/
│   └── camera_motion/
└── logs/                              # 日志目录
    ├── gpu_0/
    ├── gpu_1/
    └── gpu_2/
```

## ⚠️ 注意事项

1. **路径权限**: 确保所有配置的路径具有读写权限
2. **存储空间**: 确保输出目录有足够的存储空间
3. **网络存储**: 如果使用网络存储，确保网络连接稳定
4. **环境持久性**: 环境变量在新shell中需要重新加载
5. **路径格式**: 使用绝对路径避免相对路径问题

## 🛠️ 故障排除

### 常见问题

1. **路径不存在**
   ```bash
   # 自动创建必要目录
   mkdir -p "${EXPERIMENT_OUTPUT_DIR}"
   mkdir -p "${EXPERIMENT_LOG_DIR}"
   ```

2. **权限问题**
   ```bash
   # 修复权限
   chmod -R 755 "${EXPERIMENT_WORK_DIR}"
   chown -R $USER "${EXPERIMENT_OUTPUT_DIR}"
   ```

3. **Conda环境不存在**
   ```bash
   # 检查环境
   conda env list | grep "${CONDA_ENV}"
   
   # 创建环境
   conda create -n "${CONDA_ENV}" python=3.8
   ```

4. **模型文件缺失**
   ```bash
   # 检查模型文件
   ls -la "${MODEL_BASE_DIR}/Wan-AI/Wan2.1-T2V-14B/"
   
   # 下载模型
   python download_model.py
   ```

## 🔄 迁移指南

### 从硬编码路径迁移

1. **备份现有配置**
   ```bash
   cp incremental_experiment.sh incremental_experiment.sh.backup
   ```

2. **应用新配置**
   ```bash
   # 编辑 config.env 设置路径
   source config.env
   ```

3. **验证功能**
   ```bash
   ./incremental_experiment.sh --help
   ```

4. **测试运行**
   ```bash
   ./incremental_experiment.sh --category test --new-prompts test.json --new-videos-dir test_videos/
   ```