# ğŸš€ DiffSynth4MT å¤šGPUå¹¶è¡Œå®éªŒè¿è¡ŒæŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿé…ç½®](#ç³»ç»Ÿé…ç½®)
2. [å¿«é€Ÿå¯åŠ¨](#å¿«é€Ÿå¯åŠ¨)  
3. [è¯¦ç»†æ“ä½œæ­¥éª¤](#è¯¦ç»†æ“ä½œæ­¥éª¤)
4. [å‚æ•°è¯´æ˜](#å‚æ•°è¯´æ˜)
5. [ç›‘æ§å’Œç®¡ç†](#ç›‘æ§å’Œç®¡ç†)
6. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
7. [ç»“æœæŸ¥çœ‹](#ç»“æœæŸ¥çœ‹)

---

## ğŸ”§ ç³»ç»Ÿé…ç½®

### ç¯å¢ƒè¦æ±‚
- **GPU**: NVIDIA H20 æˆ–ç±»ä¼¼ (æ¨èæ˜¾å­˜ â‰¥ 96GB)
- **ç³»ç»Ÿ**: Linux (æµ‹è¯•ç¯å¢ƒ: Ubuntu)
- **Python**: 3.8+
- **Conda**: å·²å®‰è£…diffsynthç¯å¢ƒ

### é¢„æ£€æŸ¥æ¸…å•
```bash
# 1. æ£€æŸ¥GPUçŠ¶æ€
nvidia-smi

# 2. æ£€æŸ¥condaç¯å¢ƒ
conda info --envs | grep diffsynth

# 3. æ£€æŸ¥æ•°æ®é›†
ls /root/autodl-tmp/Final_Dataset/

# 4. æ£€æŸ¥è„šæœ¬æƒé™
ls -la /root/autodl-tmp/diffsynth4MT/*.sh
```

---

## âš¡ å¿«é€Ÿå¯åŠ¨

### ğŸ¯ æ¨èé…ç½® (ä¿å®ˆå®‰å…¨)

```bash
cd /root/autodl-tmp/diffsynth4MT
source config.env

# 4GPUæœåŠ¡å™¨ - æ¯GPU 1ä¸ªè¿›ç¨‹ (4å€åŠ é€Ÿ)
./parallel_experiment_manager.sh --mode 4gpu --dataset /root/autodl-tmp/Final_Dataset

# 8GPUæœåŠ¡å™¨ - æ¯GPU 1ä¸ªè¿›ç¨‹ (8å€åŠ é€Ÿ)  
./parallel_experiment_manager.sh --mode 8gpu-conservative --dataset /root/autodl-tmp/Final_Dataset
```

### ğŸš€ é«˜æ•ˆé…ç½® (åŸºäºæ˜¾å­˜åˆ†æ)

```bash
# 4GPUæœåŠ¡å™¨ - æ¯GPU 2ä¸ªè¿›ç¨‹ (8å€åŠ é€Ÿ)
./parallel_experiment_manager.sh --mode 4gpu --processes-per-gpu 2 --dataset /root/autodl-tmp/Final_Dataset

# 8GPUæœåŠ¡å™¨ - æ¯GPU 2ä¸ªè¿›ç¨‹ (16å€åŠ é€Ÿ)
./parallel_experiment_manager.sh --mode 8gpu-conservative --processes-per-gpu 2 --dataset /root/autodl-tmp/Final_Dataset
```

---

## ğŸ“ è¯¦ç»†æ“ä½œæ­¥éª¤

### æ­¥éª¤1: ç¯å¢ƒå‡†å¤‡

```bash
# è¿›å…¥å·¥ä½œç›®å½•
cd /root/autodl-tmp/diffsynth4MT

# æ¿€æ´»condaç¯å¢ƒ  
source config.env
conda activate diffsynth

# éªŒè¯ç¯å¢ƒ
python -c "from diffsynth import ModelManager; print('Environment OK')"
```

### æ­¥éª¤2: æ£€æŸ¥æ•°æ®é›†ç»“æ„

```bash
# è¿è¡Œæ•°æ®é›†åˆ†æ
./test_parallel_setup.sh

# é¢„æœŸè¾“å‡º:
# camera_motion: 14 ä¸ªè§†é¢‘, 140 ä¸ªä»»åŠ¡
# single_object: 19 ä¸ªè§†é¢‘, 190 ä¸ªä»»åŠ¡  
# multiple_objects: 13 ä¸ªè§†é¢‘, 130 ä¸ªä»»åŠ¡
# complex_human_motion: 8 ä¸ªè§†é¢‘, 80 ä¸ªä»»åŠ¡
# æ€»è®¡: 54 ä¸ªè§†é¢‘, 540 ä¸ªä»»åŠ¡
```

### æ­¥éª¤3: é€‰æ‹©è¿è¡Œæ¨¡å¼

#### æ¨¡å¼A: 4GPUæ ‡å‡†æ¨¡å¼
```bash
./parallel_experiment_manager.sh \
    --mode 4gpu \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 1
```

#### æ¨¡å¼B: 4GPUé«˜æ•ˆæ¨¡å¼
```bash
./parallel_experiment_manager.sh \
    --mode 4gpu \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 2
```

#### æ¨¡å¼C: 8GPUä¿å®ˆæ¨¡å¼
```bash
./parallel_experiment_manager.sh \
    --mode 8gpu-conservative \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 1
```

#### æ¨¡å¼D: 8GPUæ¿€è¿›æ¨¡å¼
```bash
./parallel_experiment_manager.sh \
    --mode 8gpu-conservative \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 3
```

### æ­¥éª¤4: æ‰‹åŠ¨å•ä»»åŠ¡æ§åˆ¶ (é«˜çº§)

```bash
# æŒ‡å®šç‰¹å®šç±»åˆ«å’Œè§†é¢‘èŒƒå›´
./incremental_experiment.sh \
    --category camera_motion \
    --video-range 1-7 \
    --gpu-id 0 \
    --instance-id part1 \
    --new-prompts /root/autodl-tmp/Final_Dataset/prompt.json \
    --new-videos-dir /root/autodl-tmp/Final_Dataset/camera_motion
```

---

## âš™ï¸ å‚æ•°è¯´æ˜

### parallel_experiment_manager.sh å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--mode` | è¿è¡Œæ¨¡å¼ | `4gpu`, `8gpu-conservative`, `8gpu-aggressive` |
| `--dataset` | æ•°æ®é›†è·¯å¾„ | `/root/autodl-tmp/Final_Dataset` |
| `--processes-per-gpu` | æ¯GPUè¿›ç¨‹æ•° | `1`, `2`, `3` (é»˜è®¤: 1) |
| `--prompts` | promptsæ–‡ä»¶ | é»˜è®¤: `{dataset}/prompt.json` |

### incremental_experiment.sh å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--category` | è§†é¢‘ç±»åˆ« | `camera_motion`, `single_object` |
| `--gpu-id` | GPUç¼–å· | `0`, `1`, `2`, `3` |
| `--video-range` | è§†é¢‘èŒƒå›´ | `1-7`, `8-14` |
| `--instance-id` | å®ä¾‹æ ‡è¯† | `part1`, `proc2` |
| `--new-prompts` | promptsæ–‡ä»¶è·¯å¾„ | `/path/to/prompt.json` |
| `--new-videos-dir` | è§†é¢‘ç›®å½•è·¯å¾„ | `/path/to/videos/` |

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# åœ¨config.envä¸­é…ç½®
EXPERIMENT_BASE_DIR=/root/autodl-tmp
EXPERIMENT_OUTPUT_DIR=/root/autodl-tmp/results_final_2  
EXPERIMENT_LOG_DIR=/root/autodl-tmp/logs
MODEL_BASE_DIR=/root/autodl-tmp/pretrained_models
```

---

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### å®æ—¶ç›‘æ§å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰å®éªŒä¼šè¯
tmux list-sessions

# æŸ¥çœ‹GPUä½¿ç”¨æƒ…å†µ
nvidia-smi

# è¿æ¥åˆ°ç‰¹å®šå®éªŒ
tmux attach-session -t incremental_camera_motion_proc1_gpu0

# æŸ¥çœ‹å®éªŒæ—¥å¿—
tail -f /root/autodl-tmp/logs/gpu_0/incremental_*.log
```

### æ˜¾å­˜ç›‘æ§

```bash
# æŒç»­ç›‘æ§æ˜¾å­˜ä½¿ç”¨
watch -n 5 'nvidia-smi --query-gpu=index,memory.used,memory.total,utilization.gpu --format=csv,noheader,nounits'

# é¢„æœŸæ˜¾å­˜ä½¿ç”¨:
# å•è¿›ç¨‹: ~10-20GB/GPU
# åŒè¿›ç¨‹: ~20-40GB/GPU  
# ä¸‰è¿›ç¨‹: ~30-60GB/GPU
```

### è¿›åº¦ç›‘æ§

```bash
# æ£€æŸ¥å®éªŒè¿›åº¦
python check_experiment_progress.py

# æ‰‹åŠ¨æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
ls -la /root/autodl-tmp/results_final_2/
```

### ä¼šè¯ç®¡ç†

```bash
# åœæ­¢å•ä¸ªå®éªŒ
tmux kill-session -t incremental_camera_motion_proc1_gpu0

# åœæ­¢æ‰€æœ‰å®éªŒ
tmux list-sessions | awk '{print $1}' | sed 's/:$//' | xargs -I {} tmux kill-session -t {}

# é‡æ–°è¿æ¥æ–­å¼€çš„å®éªŒ
tmux attach-session -t <session_name>
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æ˜¾å­˜ä¸è¶³ (OOM)
**ç—‡çŠ¶**: è¿›ç¨‹æ˜¾ç¤º `Killed`ï¼Œnvidia-smiæ˜¾ç¤ºé«˜æ˜¾å­˜ä½¿ç”¨
```bash
# è§£å†³æ–¹æ¡ˆ: å‡å°‘æ¯GPUè¿›ç¨‹æ•°
./parallel_experiment_manager.sh --mode 4gpu --processes-per-gpu 1
```

#### 2. å®éªŒæ— æ³•å¯åŠ¨
**ç—‡çŠ¶**: tmuxä¼šè¯å­˜åœ¨ä½†è¿›ç¨‹æœªè¿è¡Œ
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
source config.env
echo $EXPERIMENT_OUTPUT_DIR

# æ£€æŸ¥è·¯å¾„æƒé™
ls -la /root/autodl-tmp/Final_Dataset/
```

#### 3. æ²¡æœ‰ç”Ÿæˆè§†é¢‘æ–‡ä»¶
**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤ºå®Œæˆä½†è¾“å‡ºç›®å½•ä¸ºç©º
```bash
# æ£€æŸ¥æ—¥å¿—é”™è¯¯
grep -r "ERROR\|Failed" /root/autodl-tmp/logs/

# æ£€æŸ¥è¾“å‡ºç›®å½•æƒé™
mkdir -p /root/autodl-tmp/results_final_2
chmod 755 /root/autodl-tmp/results_final_2
```

#### 4. è¿›ç¨‹æ„å¤–ç»ˆæ­¢
**ç—‡çŠ¶**: å®éªŒä¸­é€”åœæ­¢
```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æº
df -h  # ç£ç›˜ç©ºé—´
free -h  # å†…å­˜ä½¿ç”¨

# é‡å¯ç‰¹å®šç±»åˆ«å®éªŒ
./incremental_experiment.sh --category camera_motion --gpu-id 0
```

#### 5. æ¨¡å‹åŠ è½½å¤±è´¥
**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤ºæ¨¡å‹è·¯å¾„é”™è¯¯
```bash
# æ£€æŸ¥æ¨¡å‹è·¯å¾„
ls -la /root/autodl-tmp/pretrained_models/Wan-AI/Wan2.1-T2V-14B/

# é‡æ–°è®¾ç½®ç¯å¢ƒå˜é‡
export MODEL_BASE_DIR=/root/autodl-tmp/pretrained_models
```

---

## ğŸ“ ç»“æœæŸ¥çœ‹

### è¾“å‡ºæ–‡ä»¶ç»“æ„

```
/root/autodl-tmp/results_final_2/
â”œâ”€â”€ ref_é•œå¤´ä»°è§’æ—‹è½¬_832x480_prompt1_seed1234_video.mp4
â”œâ”€â”€ ref_é•œå¤´ä»°è§’æ—‹è½¬_832x480_prompt1_seed5678_video.mp4
â”œâ”€â”€ ref_é•œå¤´ä»°è§’æ—‹è½¬_832x480_prompt2_seed9876_video.mp4
â”œâ”€â”€ ref_é•œå¤´ä»°è§’æ—‹è½¬_832x480_prompt2_seed5432_video.mp4
...
```

### æ–‡ä»¶å‘½åè§„åˆ™

```
{è§†é¢‘åç§°}_prompt{åºå·}_seed{éšæœºç§å­}_video.mp4
```

ç¤ºä¾‹:
- `ref_é•œå¤´ä»°è§’æ—‹è½¬_832x480_prompt1_seed1234_video.mp4`
- `ref_å•äººèµ°åŠ¨_832x480_prompt3_seed9876_video.mp4`

### ç»“æœç»Ÿè®¡

```bash
# ç»Ÿè®¡ç”Ÿæˆçš„è§†é¢‘æ•°é‡
find /root/autodl-tmp/results_final_2 -name "*.mp4" | wc -l

# æŒ‰ç±»åˆ«ç»Ÿè®¡
for category in camera_motion single_object multiple_objects complex_human_motion; do
    count=$(find /root/autodl-tmp/results_final_2 -name "*${category}*" | wc -l)
    echo "$category: $count ä¸ªè§†é¢‘"
done

# æ£€æŸ¥å®Œæˆåº¦
python3 << 'EOF'
import os
import json

# è¯»å–prompts
with open('/root/autodl-tmp/Final_Dataset/prompt.json', 'r') as f:
    prompts = json.load(f)

# ç»Ÿè®¡é¢„æœŸå’Œå®é™…
total_expected = sum(len(videos) * 5 * 2 for videos in prompts.values())
total_actual = len([f for f in os.listdir('/root/autodl-tmp/results_final_2') if f.endswith('.mp4')])

print(f"é¢„æœŸè§†é¢‘æ•°: {total_expected}")
print(f"å®é™…ç”Ÿæˆæ•°: {total_actual}")  
print(f"å®Œæˆç‡: {total_actual/total_expected*100:.1f}%")
EOF
```

---


---

## ğŸ”„ å¢é‡å®éªŒ

### æ–°å¢æ•°æ®å¤„ç†

```bash
# æ·»åŠ æ–°çš„promptså’Œè§†é¢‘å
./incremental_experiment.sh \
    --category new_category \
    --new-prompts /path/to/new_prompts.json \
    --new-videos-dir /path/to/new_videos/ \
    --gpu-id 0
```

### æ–­ç‚¹ç»­è·‘

ç³»ç»Ÿæ”¯æŒè‡ªåŠ¨æ–­ç‚¹ç»­è·‘:
- âœ… è‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„ä»»åŠ¡  
- âœ… åŸºäºè¾“å‡ºæ–‡ä»¶æ£€æµ‹å®ŒæˆçŠ¶æ€
- âœ… æ”¯æŒéšæœºç§å­æ¨¡å¼çš„å¢é‡å¤„ç†

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ—¥å¿—ä½ç½®
- **ä¸»æ—¥å¿—**: `/root/autodl-tmp/logs/gpu_X/incremental_*.log`
- **é…ç½®æ—¥å¿—**: `config.env`
- **ä¼šè¯æ—¥å¿—**: `tmux capture-pane -t <session_name> -p`

### è°ƒè¯•å‘½ä»¤
```bash
# å®Œæ•´ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
./test_parallel_setup.sh

# æ£€æŸ¥ç‰¹å®šGPUçŠ¶æ€
nvidia-smi -i 0

# æ£€æŸ¥å®éªŒé…ç½®
cat config.env
```

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **é¦–æ¬¡ä½¿ç”¨**: ä» `--processes-per-gpu 1` å¼€å§‹æµ‹è¯•
2. **èµ„æºç›‘æ§**: æŒç»­ç›‘æ§æ˜¾å­˜å’ŒGPUåˆ©ç”¨ç‡
3. **åˆ†æ‰¹æµ‹è¯•**: å…ˆæµ‹è¯•å°èŒƒå›´æ•°æ®ï¼ŒéªŒè¯æ— è¯¯åæ‰©å¤§è§„æ¨¡
4. **å¤‡ä»½é‡è¦æ•°æ®**: å®šæœŸå¤‡ä»½ç”Ÿæˆçš„è§†é¢‘æ–‡ä»¶
5. **æ—¥å¿—æŸ¥çœ‹**: é‡åˆ°é—®é¢˜æ—¶ä¼˜å…ˆæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶

---
