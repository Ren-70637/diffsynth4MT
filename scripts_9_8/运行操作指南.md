# 🚀 DiffSynth4MT 多GPU并行实验运行指南

## 📋 目录
1. [系统配置](#系统配置)
2. [快速启动](#快速启动)  
3. [详细操作步骤](#详细操作步骤)
4. [参数说明](#参数说明)
5. [监控和管理](#监控和管理)
6. [故障排除](#故障排除)
7. [结果查看](#结果查看)

---

## 🔧 系统配置

### 环境要求
- **GPU**: NVIDIA H20 或类似 (推荐显存 ≥ 96GB)
- **系统**: Linux (测试环境: Ubuntu)
- **Python**: 3.8+
- **Conda**: 已安装diffsynth环境

### 预检查清单
```bash
# 1. 检查GPU状态
nvidia-smi

# 2. 检查conda环境
conda info --envs | grep diffsynth

# 3. 检查数据集
ls /root/autodl-tmp/Final_Dataset/

# 4. 检查脚本权限
ls -la /root/autodl-tmp/diffsynth4MT/*.sh
```

---

## ⚡ 快速启动

### 🎯 推荐配置 (保守安全)

```bash
cd /root/autodl-tmp/diffsynth4MT
source config.env

# 4GPU服务器 - 每GPU 1个进程 (4倍加速)
./parallel_experiment_manager.sh --mode 4gpu --dataset /root/autodl-tmp/Final_Dataset

# 8GPU服务器 - 每GPU 1个进程 (8倍加速)  
./parallel_experiment_manager.sh --mode 8gpu-conservative --dataset /root/autodl-tmp/Final_Dataset
```

### 🚀 高效配置 (基于显存分析)

```bash
# 4GPU服务器 - 每GPU 2个进程 (8倍加速)
./parallel_experiment_manager.sh --mode 4gpu --processes-per-gpu 2 --dataset /root/autodl-tmp/Final_Dataset

# 8GPU服务器 - 每GPU 2个进程 (16倍加速)
./parallel_experiment_manager.sh --mode 8gpu-conservative --processes-per-gpu 2 --dataset /root/autodl-tmp/Final_Dataset
```

---

## 📝 详细操作步骤

### 步骤1: 环境准备

```bash
# 进入工作目录
cd /root/autodl-tmp/diffsynth4MT

# 激活conda环境  
source config.env
conda activate diffsynth

# 验证环境
python -c "from diffsynth import ModelManager; print('Environment OK')"
```

### 步骤2: 检查数据集结构

```bash
# 运行数据集分析
./test_parallel_setup.sh

# 预期输出:
# camera_motion: 14 个视频, 140 个任务
# single_object: 19 个视频, 190 个任务  
# multiple_objects: 13 个视频, 130 个任务
# complex_human_motion: 8 个视频, 80 个任务
# 总计: 54 个视频, 540 个任务
```

### 步骤3: 选择运行模式

#### 模式A: 4GPU标准模式
```bash
./parallel_experiment_manager.sh \
    --mode 4gpu \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 1
```

#### 模式B: 4GPU高效模式
```bash
./parallel_experiment_manager.sh \
    --mode 4gpu \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 2
```

#### 模式C: 8GPU保守模式
```bash
./parallel_experiment_manager.sh \
    --mode 8gpu-conservative \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 1
```

#### 模式D: 8GPU激进模式
```bash
./parallel_experiment_manager.sh \
    --mode 8gpu-conservative \
    --dataset /root/autodl-tmp/Final_Dataset \
    --processes-per-gpu 3
```

### 步骤4: 手动单任务控制 (高级)

```bash
# 指定特定类别和视频范围
./incremental_experiment.sh \
    --category camera_motion \
    --video-range 1-7 \
    --gpu-id 0 \
    --instance-id part1 \
    --new-prompts /root/autodl-tmp/Final_Dataset/prompt.json \
    --new-videos-dir /root/autodl-tmp/Final_Dataset/camera_motion
```

---

## ⚙️ 参数说明

### parallel_experiment_manager.sh 参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--mode` | 运行模式 | `4gpu`, `8gpu-conservative`, `8gpu-aggressive` |
| `--dataset` | 数据集路径 | `/root/autodl-tmp/Final_Dataset` |
| `--processes-per-gpu` | 每GPU进程数 | `1`, `2`, `3` (默认: 1) |
| `--prompts` | prompts文件 | 默认: `{dataset}/prompt.json` |

### incremental_experiment.sh 参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--category` | 视频类别 | `camera_motion`, `single_object` |
| `--gpu-id` | GPU编号 | `0`, `1`, `2`, `3` |
| `--video-range` | 视频范围 | `1-7`, `8-14` |
| `--instance-id` | 实例标识 | `part1`, `proc2` |
| `--new-prompts` | prompts文件路径 | `/path/to/prompt.json` |
| `--new-videos-dir` | 视频目录路径 | `/path/to/videos/` |

### 环境变量配置

```bash
# 在config.env中配置
EXPERIMENT_BASE_DIR=/root/autodl-tmp
EXPERIMENT_OUTPUT_DIR=/root/autodl-tmp/results_final_2  
EXPERIMENT_LOG_DIR=/root/autodl-tmp/logs
MODEL_BASE_DIR=/root/autodl-tmp/pretrained_models
```

---

## 📊 监控和管理

### 实时监控命令

```bash
# 查看所有实验会话
tmux list-sessions

# 查看GPU使用情况
nvidia-smi

# 连接到特定实验
tmux attach-session -t incremental_camera_motion_proc1_gpu0

# 查看实验日志
tail -f /root/autodl-tmp/logs/gpu_0/incremental_*.log
```

### 显存监控

```bash
# 持续监控显存使用
watch -n 5 'nvidia-smi --query-gpu=index,memory.used,memory.total,utilization.gpu --format=csv,noheader,nounits'

# 预期显存使用:
# 单进程: ~10-20GB/GPU
# 双进程: ~20-40GB/GPU  
# 三进程: ~30-60GB/GPU
```

### 进度监控

```bash
# 检查实验进度
python check_experiment_progress.py

# 手动检查输出文件
ls -la /root/autodl-tmp/results_final_2/
```

### 会话管理

```bash
# 停止单个实验
tmux kill-session -t incremental_camera_motion_proc1_gpu0

# 停止所有实验
tmux list-sessions | awk '{print $1}' | sed 's/:$//' | xargs -I {} tmux kill-session -t {}

# 重新连接断开的实验
tmux attach-session -t <session_name>
```

---

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 显存不足 (OOM)
**症状**: 进程显示 `Killed`，nvidia-smi显示高显存使用
```bash
# 解决方案: 减少每GPU进程数
./parallel_experiment_manager.sh --mode 4gpu --processes-per-gpu 1
```

#### 2. 实验无法启动
**症状**: tmux会话存在但进程未运行
```bash
# 检查环境变量
source config.env
echo $EXPERIMENT_OUTPUT_DIR

# 检查路径权限
ls -la /root/autodl-tmp/Final_Dataset/
```

#### 3. 没有生成视频文件
**症状**: 日志显示完成但输出目录为空
```bash
# 检查日志错误
grep -r "ERROR\|Failed" /root/autodl-tmp/logs/

# 检查输出目录权限
mkdir -p /root/autodl-tmp/results_final_2
chmod 755 /root/autodl-tmp/results_final_2
```

#### 4. 进程意外终止
**症状**: 实验中途停止
```bash
# 检查系统资源
df -h  # 磁盘空间
free -h  # 内存使用

# 重启特定类别实验
./incremental_experiment.sh --category camera_motion --gpu-id 0
```

#### 5. 模型加载失败
**症状**: 日志显示模型路径错误
```bash
# 检查模型路径
ls -la /root/autodl-tmp/pretrained_models/Wan-AI/Wan2.1-T2V-14B/

# 重新设置环境变量
export MODEL_BASE_DIR=/root/autodl-tmp/pretrained_models
```

---

## 📁 结果查看

### 输出文件结构

```
/root/autodl-tmp/results_final_2/
├── ref_镜头仰角旋转_832x480_prompt1_seed1234_video.mp4
├── ref_镜头仰角旋转_832x480_prompt1_seed5678_video.mp4
├── ref_镜头仰角旋转_832x480_prompt2_seed9876_video.mp4
├── ref_镜头仰角旋转_832x480_prompt2_seed5432_video.mp4
...
```

### 文件命名规则

```
{视频名称}_prompt{序号}_seed{随机种子}_video.mp4
```

示例:
- `ref_镜头仰角旋转_832x480_prompt1_seed1234_video.mp4`
- `ref_单人走动_832x480_prompt3_seed9876_video.mp4`

### 结果统计

```bash
# 统计生成的视频数量
find /root/autodl-tmp/results_final_2 -name "*.mp4" | wc -l

# 按类别统计
for category in camera_motion single_object multiple_objects complex_human_motion; do
    count=$(find /root/autodl-tmp/results_final_2 -name "*${category}*" | wc -l)
    echo "$category: $count 个视频"
done

# 检查完成度
python3 << 'EOF'
import os
import json

# 读取prompts
with open('/root/autodl-tmp/Final_Dataset/prompt.json', 'r') as f:
    prompts = json.load(f)

# 统计预期和实际
total_expected = sum(len(videos) * 5 * 2 for videos in prompts.values())
total_actual = len([f for f in os.listdir('/root/autodl-tmp/results_final_2') if f.endswith('.mp4')])

print(f"预期视频数: {total_expected}")
print(f"实际生成数: {total_actual}")  
print(f"完成率: {total_actual/total_expected*100:.1f}%")
EOF
```

---


---

## 🔄 增量实验

### 新增数据处理

```bash
# 添加新的prompts和视频后
./incremental_experiment.sh \
    --category new_category \
    --new-prompts /path/to/new_prompts.json \
    --new-videos-dir /path/to/new_videos/ \
    --gpu-id 0
```

### 断点续跑

系统支持自动断点续跑:
- ✅ 自动跳过已完成的任务  
- ✅ 基于输出文件检测完成状态
- ✅ 支持随机种子模式的增量处理

---

## 📞 技术支持

### 日志位置
- **主日志**: `/root/autodl-tmp/logs/gpu_X/incremental_*.log`
- **配置日志**: `config.env`
- **会话日志**: `tmux capture-pane -t <session_name> -p`

### 调试命令
```bash
# 完整系统状态检查
./test_parallel_setup.sh

# 检查特定GPU状态
nvidia-smi -i 0

# 检查实验配置
cat config.env
```

---

## 🎯 最佳实践

1. **首次使用**: 从 `--processes-per-gpu 1` 开始测试
2. **资源监控**: 持续监控显存和GPU利用率
3. **分批测试**: 先测试小范围数据，验证无误后扩大规模
4. **备份重要数据**: 定期备份生成的视频文件
5. **日志查看**: 遇到问题时优先查看日志文件

---
