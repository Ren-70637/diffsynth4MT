# ğŸšš DiffSynth4MT ä¸»æœºè¿ç§»é…ç½®æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [è¿ç§»æ¸…å•](#è¿ç§»æ¸…å•)
2. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
3. [è·¯å¾„é…ç½®](#è·¯å¾„é…ç½®)
4. [æ–‡ä»¶è¿ç§»](#æ–‡ä»¶è¿ç§»)
5. [éªŒè¯æµ‹è¯•](#éªŒè¯æµ‹è¯•)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ“¦ è¿ç§»æ¸…å•

### å¿…éœ€æ–‡ä»¶/ç›®å½•
```
ğŸ“ å®éªŒç³»ç»Ÿæ ¸å¿ƒæ–‡ä»¶
â”œâ”€â”€ diffsynth4MT/                           # ä¸»å®éªŒç›®å½•
â”‚   â”œâ”€â”€ FastVMT_incremental.py             # âœ… æ ¸å¿ƒå®éªŒè„šæœ¬
â”‚   â”œâ”€â”€ parallel_experiment_manager.sh     # âœ… å¹¶è¡Œç®¡ç†å™¨
â”‚   â”œâ”€â”€ incremental_experiment.sh          # âœ… å¢é‡å®éªŒè„šæœ¬
â”‚   â”œâ”€â”€ check_experiment_progress.py       # âœ… è¿›åº¦æ£€æŸ¥è„šæœ¬
â”‚   â”œâ”€â”€ config.env.template               # âœ… é…ç½®æ¨¡æ¿ (æ–°å»º)
â”‚   â”œâ”€â”€ è¿è¡Œæ“ä½œæŒ‡å—.md                    # âœ… ä½¿ç”¨è¯´æ˜
â”‚   â”œâ”€â”€ test_parallel_setup.sh            # âœ… æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_random_seeds.sh              # âœ… éšæœºç§å­æµ‹è¯•
â”‚   â””â”€â”€ setup_new_host.sh                 # âœ… è‡ªåŠ¨é…ç½®è„šæœ¬ (æ–°å»º)

ğŸ“ æ•°æ®å’Œæ¨¡å‹ (éœ€è¦å•ç‹¬è¿ç§»)
â”œâ”€â”€ Final_Dataset/                         # æ•°æ®é›†ç›®å½•
â”‚   â”œâ”€â”€ prompt.json                        # promptsæ–‡ä»¶
â”‚   â”œâ”€â”€ camera_motion/                     # å„ç±»åˆ«è§†é¢‘
â”‚   â”œâ”€â”€ single_object/
â”‚   â”œâ”€â”€ multiple_objects/
â”‚   â””â”€â”€ complex_human_motion/
â”œâ”€â”€ pretrained_models/                     # é¢„è®­ç»ƒæ¨¡å‹
â”‚   â””â”€â”€ Wan-AI/Wan2.1-T2V-14B/           # æ¨¡å‹æ–‡ä»¶
â””â”€â”€ logs/                                  # æ—¥å¿—ç›®å½• (å¯é€‰)
```

---

## ğŸ› ï¸ ç¯å¢ƒé…ç½®

### æ­¥éª¤1: ç³»ç»Ÿè¦æ±‚æ£€æŸ¥

```bash
# 1. æ£€æŸ¥NVIDIAé©±åŠ¨å’ŒCUDA
nvidia-smi
nvcc --version

# 2. æ£€æŸ¥Pythonç‰ˆæœ¬
python3 --version  # éœ€è¦ >= 3.8

# 3. æ£€æŸ¥condaå®‰è£…
conda --version
```

### æ­¥éª¤2: åˆ›å»ºcondaç¯å¢ƒ

```bash
# åˆ›å»ºæ–°ç¯å¢ƒ
conda create -n diffsynth python=3.9 -y
conda activate diffsynth

# å®‰è£…åŸºç¡€ä¾èµ–
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install diffusers transformers accelerate
pip install opencv-python imageio imageio-ffmpeg
pip install numpy pillow

# å®‰è£…diffsynth (æ ¹æ®ä½ çš„å…·ä½“ç‰ˆæœ¬)
# æ–¹æ³•1: å¦‚æœæœ‰pipåŒ…
pip install diffsynth

# æ–¹æ³•2: å¦‚æœæ˜¯æœ¬åœ°å®‰è£…
# cd /path/to/diffsynth && pip install -e .
```

### æ­¥éª¤3: éªŒè¯ç¯å¢ƒ

```bash
python3 -c "
import torch
import diffsynth
print(f'PyTorch: {torch.__version__}')
print(f'CUDA available: {torch.cuda.is_available()}')
print(f'GPU count: {torch.cuda.device_count()}')
print('DiffSynth imported successfully')
"
```

---

## ğŸ“ è·¯å¾„é…ç½®

### è‡ªåŠ¨é…ç½®è„šæœ¬

æˆ‘ä¼šåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é…ç½®è„šæœ¬ `setup_new_host.sh`ï¼š

```bash
#!/bin/bash
# æ–°ä¸»æœºè‡ªåŠ¨é…ç½®è„šæœ¬

# ä½¿ç”¨æ–¹æ³•:
# ./setup_new_host.sh /new/base/path

set -e

if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 <åŸºç¡€è·¯å¾„>"
    echo "ç¤ºä¾‹: $0 /data/experiments"
    exit 1
fi

BASE_PATH="$1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ğŸš€ å¼€å§‹é…ç½®æ–°ä¸»æœºç¯å¢ƒ..."
echo "åŸºç¡€è·¯å¾„: $BASE_PATH"
echo "è„šæœ¬ç›®å½•: $SCRIPT_DIR"

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p "$BASE_PATH"/{logs,results_final_2,pretrained_models}
mkdir -p "$BASE_PATH"/logs/gpu_{0..7}

# å¤åˆ¶é…ç½®æ¨¡æ¿
cp "$SCRIPT_DIR/config.env.template" "$SCRIPT_DIR/config.env"

# æ›´æ–°é…ç½®æ–‡ä»¶
sed -i "s|EXPERIMENT_BASE_DIR=.*|EXPERIMENT_BASE_DIR=$BASE_PATH|" "$SCRIPT_DIR/config.env"
sed -i "s|EXPERIMENT_WORK_DIR=.*|EXPERIMENT_WORK_DIR=$SCRIPT_DIR|" "$SCRIPT_DIR/config.env"

echo "âœ… é…ç½®å®Œæˆï¼"
echo "è¯·æ ¹æ®å®é™…æƒ…å†µç¼–è¾‘ config.env æ–‡ä»¶"
```

### é…ç½®æ¨¡æ¿

```bash
# config.env.template - é…ç½®æ–‡ä»¶æ¨¡æ¿
# å¤åˆ¶ä¸º config.env å¹¶æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹

# =============================================================================
# ğŸ”§ åŸºç¡€è·¯å¾„é…ç½® (å¿…é¡»ä¿®æ”¹)
# =============================================================================

# å®éªŒåŸºç¡€ç›®å½• - ä¿®æ”¹ä¸ºä½ çš„å®é™…è·¯å¾„
export EXPERIMENT_BASE_DIR="/your/base/path"

# å·¥ä½œç›®å½• - diffsynth4MTè„šæœ¬æ‰€åœ¨ç›®å½•
export EXPERIMENT_WORK_DIR="/your/script/path/diffsynth4MT"

# =============================================================================
# ğŸ“ å­ç›®å½•é…ç½® (åŸºäºåŸºç¡€ç›®å½•è‡ªåŠ¨è®¡ç®—ï¼Œä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹)
# =============================================================================

# è¾“å‡ºç›®å½•
export EXPERIMENT_OUTPUT_DIR="${EXPERIMENT_BASE_DIR}/results_final_2"

# æ—¥å¿—ç›®å½•
export EXPERIMENT_LOG_DIR="${EXPERIMENT_BASE_DIR}/logs"

# æ•°æ®é›†ç›®å½•
export EXPERIMENT_DATA_DIR="${EXPERIMENT_BASE_DIR}/Final_Dataset"

# promptsæ–‡ä»¶è·¯å¾„
export EXPERIMENT_PROMPTS_FILE="${EXPERIMENT_DATA_DIR}/prompt.json"

# =============================================================================
# ğŸ¤– æ¨¡å‹é…ç½®
# =============================================================================

# æ¨¡å‹åŸºç¡€ç›®å½•
export MODEL_BASE_DIR="${EXPERIMENT_BASE_DIR}/pretrained_models"

# =============================================================================
# ğŸ Condaç¯å¢ƒé…ç½®  
# =============================================================================

# Condaå®‰è£…è·¯å¾„ (æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹)
export CONDA_BASE="/opt/miniconda3"  # æˆ– "/root/miniconda3"

# Condaç¯å¢ƒåç§°
export CONDA_ENV="diffsynth"

# =============================================================================
# âœ… é…ç½®éªŒè¯
# =============================================================================

echo "ğŸ“‹ å½“å‰é…ç½®:"
echo "  åŸºç¡€ç›®å½•: $EXPERIMENT_BASE_DIR"
echo "  å·¥ä½œç›®å½•: $EXPERIMENT_WORK_DIR"  
echo "  è¾“å‡ºç›®å½•: $EXPERIMENT_OUTPUT_DIR"
echo "  æ¨¡å‹ç›®å½•: $MODEL_BASE_DIR"
echo "  Condaç¯å¢ƒ: $CONDA_ENV"
```

---

## ğŸ“‚ æ–‡ä»¶è¿ç§»

### è¿ç§»æ£€æŸ¥æ¸…å•

#### 1. æ ¸å¿ƒè„šæœ¬æ–‡ä»¶ (å¿…éœ€)
```bash
# æ£€æŸ¥è¿™äº›æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la diffsynth4MT/FastVMT_incremental.py
ls -la diffsynth4MT/parallel_experiment_manager.sh  
ls -la diffsynth4MT/incremental_experiment.sh
ls -la diffsynth4MT/check_experiment_progress.py
```

#### 2. æ•°æ®é›† (å¿…éœ€)
```bash
# æ£€æŸ¥æ•°æ®é›†å®Œæ•´æ€§
ls -la Final_Dataset/prompt.json
ls -la Final_Dataset/camera_motion/
ls -la Final_Dataset/single_object/
ls -la Final_Dataset/multiple_objects/
ls -la Final_Dataset/complex_human_motion/

# ç»Ÿè®¡è§†é¢‘æ•°é‡
find Final_Dataset -name "*.mp4" | wc -l
```

#### 3. é¢„è®­ç»ƒæ¨¡å‹ (å¿…éœ€)
```bash
# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
ls -la pretrained_models/Wan-AI/Wan2.1-T2V-14B/
du -sh pretrained_models/  # æ£€æŸ¥æ¨¡å‹å¤§å°
```

#### 4. å¯é€‰æ–‡ä»¶
```bash
# å†å²æ—¥å¿— (å¯é€‰)
ls -la logs/

# å†å²ç»“æœ (å¯é€‰)  
ls -la results_final_2/
```

### è¿ç§»è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# æ•°æ®è¿ç§»è„šæœ¬

SOURCE_HOST="user@source-server"
SOURCE_PATH="/root/autodl-tmp"
TARGET_PATH="/data/experiments"

echo "ğŸšš å¼€å§‹æ•°æ®è¿ç§»..."

# 1. è¿ç§»æ ¸å¿ƒè„šæœ¬
echo "ğŸ“ è¿ç§»æ ¸å¿ƒè„šæœ¬..."
rsync -avz --progress \
  "$SOURCE_HOST:$SOURCE_PATH/diffsynth4MT/" \
  "$TARGET_PATH/diffsynth4MT/"

# 2. è¿ç§»æ•°æ®é›†
echo "ğŸ“Š è¿ç§»æ•°æ®é›†..."
rsync -avz --progress \
  "$SOURCE_HOST:$SOURCE_PATH/Final_Dataset/" \
  "$TARGET_PATH/Final_Dataset/"

# 3. è¿ç§»æ¨¡å‹
echo "ğŸ¤– è¿ç§»é¢„è®­ç»ƒæ¨¡å‹..."
rsync -avz --progress \
  "$SOURCE_HOST:$SOURCE_PATH/pretrained_models/" \
  "$TARGET_PATH/pretrained_models/"

# 4. å¯é€‰: è¿ç§»å†å²ç»“æœ
read -p "æ˜¯å¦è¿ç§»å†å²ç»“æœ? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ğŸ“ˆ è¿ç§»å†å²ç»“æœ..."
    rsync -avz --progress \
      "$SOURCE_HOST:$SOURCE_PATH/results_final_2/" \
      "$TARGET_PATH/results_final_2/"
fi

echo "âœ… è¿ç§»å®Œæˆï¼"
```

---

## ğŸ§ª éªŒè¯æµ‹è¯•

### è‡ªåŠ¨éªŒè¯è„šæœ¬

åˆ›å»ºå®Œæ•´çš„éªŒè¯è„šæœ¬ï¼š

```bash
#!/bin/bash
# validate_setup.sh - æ–°ä¸»æœºé…ç½®éªŒè¯è„šæœ¬

echo "ğŸ§ª å¼€å§‹ç¯å¢ƒéªŒè¯..."

# 1. æ£€æŸ¥åŸºç¡€ç¯å¢ƒ
echo "1ï¸âƒ£ æ£€æŸ¥åŸºç¡€ç¯å¢ƒ..."
python3 --version || { echo "âŒ Python3æœªå®‰è£…"; exit 1; }
nvidia-smi > /dev/null || { echo "âŒ NVIDIAé©±åŠ¨æœªå®‰è£…"; exit 1; }
conda --version > /dev/null || { echo "âŒ Condaæœªå®‰è£…"; exit 1; }

# 2. æ£€æŸ¥condaç¯å¢ƒ
echo "2ï¸âƒ£ æ£€æŸ¥condaç¯å¢ƒ..."
source config.env
conda activate $CONDA_ENV || { echo "âŒ Condaç¯å¢ƒ $CONDA_ENV ä¸å­˜åœ¨"; exit 1; }

# 3. æ£€æŸ¥PythonåŒ…
echo "3ï¸âƒ£ æ£€æŸ¥PythonåŒ…..."
python3 -c "import torch; print(f'PyTorch: {torch.__version__}')" || { echo "âŒ PyTorchæœªå®‰è£…"; exit 1; }
python3 -c "import diffsynth; print('DiffSynthå¯¼å…¥æˆåŠŸ')" || { echo "âŒ DiffSynthæœªå®‰è£…"; exit 1; }

# 4. æ£€æŸ¥GPU
echo "4ï¸âƒ£ æ£€æŸ¥GPU..."
python3 -c "
import torch
if torch.cuda.is_available():
    print(f'âœ… æ£€æµ‹åˆ° {torch.cuda.device_count()} ä¸ªGPU')
    for i in range(torch.cuda.device_count()):
        print(f'  GPU {i}: {torch.cuda.get_device_name(i)}')
else:
    print('âŒ æœªæ£€æµ‹åˆ°GPU')
    exit(1)
"

# 5. æ£€æŸ¥ç›®å½•ç»“æ„
echo "5ï¸âƒ£ æ£€æŸ¥ç›®å½•ç»“æ„..."
required_dirs=(
    "$EXPERIMENT_BASE_DIR"
    "$EXPERIMENT_OUTPUT_DIR" 
    "$EXPERIMENT_LOG_DIR"
    "$MODEL_BASE_DIR"
    "$EXPERIMENT_DATA_DIR"
)

for dir in "${required_dirs[@]}"; do
    if [ -d "$dir" ]; then
        echo "âœ… $dir"
    else
        echo "âŒ $dir ä¸å­˜åœ¨"
        exit 1
    fi
done

# 6. æ£€æŸ¥å…³é”®æ–‡ä»¶
echo "6ï¸âƒ£ æ£€æŸ¥å…³é”®æ–‡ä»¶..."
required_files=(
    "$EXPERIMENT_PROMPTS_FILE"
    "FastVMT_incremental.py"
    "parallel_experiment_manager.sh"
    "incremental_experiment.sh"
)

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "âœ… $file"
    else
        echo "âŒ $file ä¸å­˜åœ¨"
        exit 1
    fi
done

# 7. æ£€æŸ¥è„šæœ¬æƒé™
echo "7ï¸âƒ£ æ£€æŸ¥è„šæœ¬æƒé™..."
chmod +x *.sh
echo "âœ… è„šæœ¬æƒé™å·²è®¾ç½®"

# 8. è¿è¡ŒåŠŸèƒ½æµ‹è¯•
echo "8ï¸âƒ£ è¿è¡ŒåŠŸèƒ½æµ‹è¯•..."
./test_parallel_setup.sh
./test_random_seeds.sh

echo ""
echo "ğŸ‰ ç¯å¢ƒéªŒè¯å®Œæˆï¼"
echo "ğŸ’¡ ç°åœ¨å¯ä»¥è¿è¡Œå®éªŒäº†:"
echo "   ./parallel_experiment_manager.sh --mode 4gpu --dataset $EXPERIMENT_DATA_DIR"
```

### å¿«é€Ÿæµ‹è¯•å‘½ä»¤

```bash
# è¿›å…¥å·¥ä½œç›®å½•
cd /your/script/path/diffsynth4MT

# åŠ è½½é…ç½®
source config.env

# è¿è¡ŒéªŒè¯
./validate_setup.sh

# å¿«é€ŸåŠŸèƒ½æµ‹è¯•
./test_parallel_setup.sh
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: condaç¯å¢ƒæ¿€æ´»å¤±è´¥
```bash
# è§£å†³æ–¹æ¡ˆ1: åˆå§‹åŒ–conda
conda init bash
source ~/.bashrc

# è§£å†³æ–¹æ¡ˆ2: æ‰‹åŠ¨æŒ‡å®šcondaè·¯å¾„
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate diffsynth
```

### Q2: æ˜¾å­˜ä¸è¶³
```bash
# è§£å†³æ–¹æ¡ˆ: é™ä½å¹¶å‘æ•°
./parallel_experiment_manager.sh --mode 4gpu --processes-per-gpu 1
```

### Q3: æ¨¡å‹åŠ è½½å¤±è´¥
```bash
# æ£€æŸ¥æ¨¡å‹è·¯å¾„
echo $MODEL_BASE_DIR
ls -la $MODEL_BASE_DIR/Wan-AI/Wan2.1-T2V-14B/

# é‡æ–°è®¾ç½®ç¯å¢ƒå˜é‡
export MODEL_BASE_DIR="/your/actual/model/path"
```

### Q4: æƒé™é—®é¢˜
```bash
# è®¾ç½®ç›®å½•æƒé™
chmod -R 755 /your/base/path/
chown -R $USER:$USER /your/base/path/

# è®¾ç½®è„šæœ¬æƒé™  
chmod +x diffsynth4MT/*.sh
```

### Q5: è·¯å¾„é…ç½®é”™è¯¯
```bash
# é‡æ–°è¿è¡Œé…ç½®è„šæœ¬
./setup_new_host.sh /your/correct/base/path

# æ‰‹åŠ¨ç¼–è¾‘é…ç½®
vim config.env
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æµç¨‹

### 1. ä¸€é”®éƒ¨ç½²å‘½ä»¤

```bash
# åœ¨æ–°ä¸»æœºä¸Šæ‰§è¡Œ
git clone <your-repo> diffsynth4MT  # æˆ–å¤åˆ¶æ–‡ä»¶
cd diffsynth4MT

# è¿è¡Œè‡ªåŠ¨é…ç½®
./setup_new_host.sh /data/experiments

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim config.env

# è¿è¡ŒéªŒè¯
./validate_setup.sh

# å¼€å§‹å®éªŒ
./parallel_experiment_manager.sh --mode 4gpu --dataset /data/experiments/Final_Dataset
```

### 2. é…ç½®æ£€æŸ¥æ¸…å•

- [ ] âœ… ç³»ç»Ÿç¯å¢ƒ (Python, CUDA, Conda)
- [ ] âœ… Condaç¯å¢ƒ (diffsynth)
- [ ] âœ… PythonåŒ… (PyTorch, DiffSynthç­‰)
- [ ] âœ… ç›®å½•ç»“æ„ (åŸºç¡€ç›®å½•åŠå­ç›®å½•)
- [ ] âœ… æ•°æ®æ–‡ä»¶ (æ•°æ®é›†, æ¨¡å‹, prompts)
- [ ] âœ… è„šæœ¬æƒé™ (æ‰§è¡Œæƒé™)
- [ ] âœ… é…ç½®æ–‡ä»¶ (config.env)
- [ ] âœ… åŠŸèƒ½æµ‹è¯• (éªŒè¯è„šæœ¬é€šè¿‡)

---