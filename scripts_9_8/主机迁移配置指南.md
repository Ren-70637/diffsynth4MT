# 🚚 DiffSynth4MT 主机迁移配置指南

## 📋 目录
1. [迁移清单](#迁移清单)
2. [环境配置](#环境配置)
3. [路径配置](#路径配置)
4. [文件迁移](#文件迁移)
5. [验证测试](#验证测试)
6. [常见问题](#常见问题)

---

## 📦 迁移清单

### 必需文件/目录
```
📁 实验系统核心文件
├── diffsynth4MT/                           # 主实验目录
│   ├── FastVMT_incremental.py             # ✅ 核心实验脚本
│   ├── parallel_experiment_manager.sh     # ✅ 并行管理器
│   ├── incremental_experiment.sh          # ✅ 增量实验脚本
│   ├── check_experiment_progress.py       # ✅ 进度检查脚本
│   ├── config.env.template               # ✅ 配置模板 (新建)
│   ├── 运行操作指南.md                    # ✅ 使用说明
│   ├── test_parallel_setup.sh            # ✅ 测试脚本
│   ├── test_random_seeds.sh              # ✅ 随机种子测试
│   └── setup_new_host.sh                 # ✅ 自动配置脚本 (新建)

📁 数据和模型 (需要单独迁移)
├── Final_Dataset/                         # 数据集目录
│   ├── prompt.json                        # prompts文件
│   ├── camera_motion/                     # 各类别视频
│   ├── single_object/
│   ├── multiple_objects/
│   └── complex_human_motion/
├── pretrained_models/                     # 预训练模型
│   └── Wan-AI/Wan2.1-T2V-14B/           # 模型文件
└── logs/                                  # 日志目录 (可选)
```

---

## 🛠️ 环境配置

### 步骤1: 系统要求检查

```bash
# 1. 检查NVIDIA驱动和CUDA
nvidia-smi
nvcc --version

# 2. 检查Python版本
python3 --version  # 需要 >= 3.8

# 3. 检查conda安装
conda --version
```

### 步骤2: 创建conda环境

```bash
# 创建新环境
conda create -n diffsynth python=3.9 -y
conda activate diffsynth

# 安装基础依赖
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install diffusers transformers accelerate
pip install opencv-python imageio imageio-ffmpeg
pip install numpy pillow

# 安装diffsynth (根据你的具体版本)
# 方法1: 如果有pip包
pip install diffsynth

# 方法2: 如果是本地安装
# cd /path/to/diffsynth && pip install -e .
```

### 步骤3: 验证环境

```bash
python3 -c "
import torch
import diffsynth
print(f'PyTorch: {torch.__version__}')
print(f'CUDA available: {torch.cuda.is_available()}')
print(f'GPU count: {torch.cuda.device_count()}')
print('DiffSynth imported successfully')
"
```

---

## 📁 路径配置

### 自动配置脚本

我会创建一个自动配置脚本 `setup_new_host.sh`：

```bash
#!/bin/bash
# 新主机自动配置脚本

# 使用方法:
# ./setup_new_host.sh /new/base/path

set -e

if [ $# -eq 0 ]; then
    echo "用法: $0 <基础路径>"
    echo "示例: $0 /data/experiments"
    exit 1
fi

BASE_PATH="$1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "🚀 开始配置新主机环境..."
echo "基础路径: $BASE_PATH"
echo "脚本目录: $SCRIPT_DIR"

# 创建目录结构
mkdir -p "$BASE_PATH"/{logs,results_final_2,pretrained_models}
mkdir -p "$BASE_PATH"/logs/gpu_{0..7}

# 复制配置模板
cp "$SCRIPT_DIR/config.env.template" "$SCRIPT_DIR/config.env"

# 更新配置文件
sed -i "s|EXPERIMENT_BASE_DIR=.*|EXPERIMENT_BASE_DIR=$BASE_PATH|" "$SCRIPT_DIR/config.env"
sed -i "s|EXPERIMENT_WORK_DIR=.*|EXPERIMENT_WORK_DIR=$SCRIPT_DIR|" "$SCRIPT_DIR/config.env"

echo "✅ 配置完成！"
echo "请根据实际情况编辑 config.env 文件"
```

### 配置模板

```bash
# config.env.template - 配置文件模板
# 复制为 config.env 并根据实际环境修改

# =============================================================================
# 🔧 基础路径配置 (必须修改)
# =============================================================================

# 实验基础目录 - 修改为你的实际路径
export EXPERIMENT_BASE_DIR="/your/base/path"

# 工作目录 - diffsynth4MT脚本所在目录
export EXPERIMENT_WORK_DIR="/your/script/path/diffsynth4MT"

# =============================================================================
# 📁 子目录配置 (基于基础目录自动计算，一般不需要修改)
# =============================================================================

# 输出目录
export EXPERIMENT_OUTPUT_DIR="${EXPERIMENT_BASE_DIR}/results_final_2"

# 日志目录
export EXPERIMENT_LOG_DIR="${EXPERIMENT_BASE_DIR}/logs"

# 数据集目录
export EXPERIMENT_DATA_DIR="${EXPERIMENT_BASE_DIR}/Final_Dataset"

# prompts文件路径
export EXPERIMENT_PROMPTS_FILE="${EXPERIMENT_DATA_DIR}/prompt.json"

# =============================================================================
# 🤖 模型配置
# =============================================================================

# 模型基础目录
export MODEL_BASE_DIR="${EXPERIMENT_BASE_DIR}/pretrained_models"

# =============================================================================
# 🐍 Conda环境配置  
# =============================================================================

# Conda安装路径 (根据实际情况修改)
export CONDA_BASE="/opt/miniconda3"  # 或 "/root/miniconda3"

# Conda环境名称
export CONDA_ENV="diffsynth"

# =============================================================================
# ✅ 配置验证
# =============================================================================

echo "📋 当前配置:"
echo "  基础目录: $EXPERIMENT_BASE_DIR"
echo "  工作目录: $EXPERIMENT_WORK_DIR"  
echo "  输出目录: $EXPERIMENT_OUTPUT_DIR"
echo "  模型目录: $MODEL_BASE_DIR"
echo "  Conda环境: $CONDA_ENV"
```

---

## 📂 文件迁移

### 迁移检查清单

#### 1. 核心脚本文件 (必需)
```bash
# 检查这些文件是否存在
ls -la diffsynth4MT/FastVMT_incremental.py
ls -la diffsynth4MT/parallel_experiment_manager.sh  
ls -la diffsynth4MT/incremental_experiment.sh
ls -la diffsynth4MT/check_experiment_progress.py
```

#### 2. 数据集 (必需)
```bash
# 检查数据集完整性
ls -la Final_Dataset/prompt.json
ls -la Final_Dataset/camera_motion/
ls -la Final_Dataset/single_object/
ls -la Final_Dataset/multiple_objects/
ls -la Final_Dataset/complex_human_motion/

# 统计视频数量
find Final_Dataset -name "*.mp4" | wc -l
```

#### 3. 预训练模型 (必需)
```bash
# 检查模型文件
ls -la pretrained_models/Wan-AI/Wan2.1-T2V-14B/
du -sh pretrained_models/  # 检查模型大小
```

#### 4. 可选文件
```bash
# 历史日志 (可选)
ls -la logs/

# 历史结果 (可选)  
ls -la results_final_2/
```

### 迁移脚本示例

```bash
#!/bin/bash
# 数据迁移脚本

SOURCE_HOST="user@source-server"
SOURCE_PATH="/root/autodl-tmp"
TARGET_PATH="/data/experiments"

echo "🚚 开始数据迁移..."

# 1. 迁移核心脚本
echo "📁 迁移核心脚本..."
rsync -avz --progress \
  "$SOURCE_HOST:$SOURCE_PATH/diffsynth4MT/" \
  "$TARGET_PATH/diffsynth4MT/"

# 2. 迁移数据集
echo "📊 迁移数据集..."
rsync -avz --progress \
  "$SOURCE_HOST:$SOURCE_PATH/Final_Dataset/" \
  "$TARGET_PATH/Final_Dataset/"

# 3. 迁移模型
echo "🤖 迁移预训练模型..."
rsync -avz --progress \
  "$SOURCE_HOST:$SOURCE_PATH/pretrained_models/" \
  "$TARGET_PATH/pretrained_models/"

# 4. 可选: 迁移历史结果
read -p "是否迁移历史结果? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "📈 迁移历史结果..."
    rsync -avz --progress \
      "$SOURCE_HOST:$SOURCE_PATH/results_final_2/" \
      "$TARGET_PATH/results_final_2/"
fi

echo "✅ 迁移完成！"
```

---

## 🧪 验证测试

### 自动验证脚本

创建完整的验证脚本：

```bash
#!/bin/bash
# validate_setup.sh - 新主机配置验证脚本

echo "🧪 开始环境验证..."

# 1. 检查基础环境
echo "1️⃣ 检查基础环境..."
python3 --version || { echo "❌ Python3未安装"; exit 1; }
nvidia-smi > /dev/null || { echo "❌ NVIDIA驱动未安装"; exit 1; }
conda --version > /dev/null || { echo "❌ Conda未安装"; exit 1; }

# 2. 检查conda环境
echo "2️⃣ 检查conda环境..."
source config.env
conda activate $CONDA_ENV || { echo "❌ Conda环境 $CONDA_ENV 不存在"; exit 1; }

# 3. 检查Python包
echo "3️⃣ 检查Python包..."
python3 -c "import torch; print(f'PyTorch: {torch.__version__}')" || { echo "❌ PyTorch未安装"; exit 1; }
python3 -c "import diffsynth; print('DiffSynth导入成功')" || { echo "❌ DiffSynth未安装"; exit 1; }

# 4. 检查GPU
echo "4️⃣ 检查GPU..."
python3 -c "
import torch
if torch.cuda.is_available():
    print(f'✅ 检测到 {torch.cuda.device_count()} 个GPU')
    for i in range(torch.cuda.device_count()):
        print(f'  GPU {i}: {torch.cuda.get_device_name(i)}')
else:
    print('❌ 未检测到GPU')
    exit(1)
"

# 5. 检查目录结构
echo "5️⃣ 检查目录结构..."
required_dirs=(
    "$EXPERIMENT_BASE_DIR"
    "$EXPERIMENT_OUTPUT_DIR" 
    "$EXPERIMENT_LOG_DIR"
    "$MODEL_BASE_DIR"
    "$EXPERIMENT_DATA_DIR"
)

for dir in "${required_dirs[@]}"; do
    if [ -d "$dir" ]; then
        echo "✅ $dir"
    else
        echo "❌ $dir 不存在"
        exit 1
    fi
done

# 6. 检查关键文件
echo "6️⃣ 检查关键文件..."
required_files=(
    "$EXPERIMENT_PROMPTS_FILE"
    "FastVMT_incremental.py"
    "parallel_experiment_manager.sh"
    "incremental_experiment.sh"
)

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "✅ $file"
    else
        echo "❌ $file 不存在"
        exit 1
    fi
done

# 7. 检查脚本权限
echo "7️⃣ 检查脚本权限..."
chmod +x *.sh
echo "✅ 脚本权限已设置"

# 8. 运行功能测试
echo "8️⃣ 运行功能测试..."
./test_parallel_setup.sh
./test_random_seeds.sh

echo ""
echo "🎉 环境验证完成！"
echo "💡 现在可以运行实验了:"
echo "   ./parallel_experiment_manager.sh --mode 4gpu --dataset $EXPERIMENT_DATA_DIR"
```

### 快速测试命令

```bash
# 进入工作目录
cd /your/script/path/diffsynth4MT

# 加载配置
source config.env

# 运行验证
./validate_setup.sh

# 快速功能测试
./test_parallel_setup.sh
```

---

## ❓ 常见问题

### Q1: conda环境激活失败
```bash
# 解决方案1: 初始化conda
conda init bash
source ~/.bashrc

# 解决方案2: 手动指定conda路径
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate diffsynth
```

### Q2: 显存不足
```bash
# 解决方案: 降低并发数
./parallel_experiment_manager.sh --mode 4gpu --processes-per-gpu 1
```

### Q3: 模型加载失败
```bash
# 检查模型路径
echo $MODEL_BASE_DIR
ls -la $MODEL_BASE_DIR/Wan-AI/Wan2.1-T2V-14B/

# 重新设置环境变量
export MODEL_BASE_DIR="/your/actual/model/path"
```

### Q4: 权限问题
```bash
# 设置目录权限
chmod -R 755 /your/base/path/
chown -R $USER:$USER /your/base/path/

# 设置脚本权限  
chmod +x diffsynth4MT/*.sh
```

### Q5: 路径配置错误
```bash
# 重新运行配置脚本
./setup_new_host.sh /your/correct/base/path

# 手动编辑配置
vim config.env
```

---

## 🚀 快速部署流程

### 1. 一键部署命令

```bash
# 在新主机上执行
git clone <your-repo> diffsynth4MT  # 或复制文件
cd diffsynth4MT

# 运行自动配置
./setup_new_host.sh /data/experiments

# 编辑配置文件
vim config.env

# 运行验证
./validate_setup.sh

# 开始实验
./parallel_experiment_manager.sh --mode 4gpu --dataset /data/experiments/Final_Dataset
```

### 2. 配置检查清单

- [ ] ✅ 系统环境 (Python, CUDA, Conda)
- [ ] ✅ Conda环境 (diffsynth)
- [ ] ✅ Python包 (PyTorch, DiffSynth等)
- [ ] ✅ 目录结构 (基础目录及子目录)
- [ ] ✅ 数据文件 (数据集, 模型, prompts)
- [ ] ✅ 脚本权限 (执行权限)
- [ ] ✅ 配置文件 (config.env)
- [ ] ✅ 功能测试 (验证脚本通过)

---